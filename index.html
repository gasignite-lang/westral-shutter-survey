<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Westral Survey">
    <!-- Android PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f1f40">
    <!-- Touch optimization -->
    <meta name="format-detection" content="telephone=no">
    <title>Westral Shutter Survey</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Gemini AI scan uses REST API directly via fetch - no SDK needed -->
    <style>
        :root {
            --westral-green: #009a49;
            --westral-yellow: #fff200;
            --norman-blue: #0f1f40;
            --bg-light: #f8f9fa;
            --border: #dee2e6;
            --text-muted: #6c757d;
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
            --scanned: #0d6efd;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-light);
            color: #212529;
        }

        .app {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .view {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 100px;
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Extra padding for views with sub-tabs */
        #v-survey.active,
        #v-specs.active {
            padding-bottom: 160px;
        }

        /* Nav */
        .nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            display: flex;
            background: white;
            border-top: 1px solid var(--border);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
        }

        .nav-btn {
            flex: 1;
            border: none;
            background: none;
            padding: 8px 2px 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-muted);
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
        }

        .nav-btn svg {
            width: 20px;
            height: 20px;
            margin-bottom: 2px;
        }

        .nav-btn.active {
            color: var(--norman-blue);
            background: #e8f4fc;
        }

        /* Typography */
        h2 {
            color: var(--norman-blue);
            font-size: 18px;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--norman-blue);
        }

        .label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            display: block;
        }

        /* Forms */
        input,
        select,
        textarea {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            font-size: 16px;
            margin-bottom: 12px;
            background: white;
            -webkit-appearance: none;
            appearance: none;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--norman-blue);
            box-shadow: 0 0 0 3px rgba(15, 31, 64, 0.1);
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236c757d' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        /* Scanned data = blue */
        .scanned {
            color: var(--scanned) !important;
            background: #e7f1ff !important;
            border-color: #b6d4fe !important;
        }

        /* Error = red */
        .error {
            color: var(--danger) !important;
            border-color: var(--danger) !important;
        }

        /* Buttons */
        .btn {
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .btn-primary {
            background: var(--norman-blue);
            color: white;
        }

        .btn-scan {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            color: white;
        }

        .btn-success {
            background: var(--westral-green);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: white;
            border: 2px solid var(--norman-blue);
            color: var(--norman-blue);
        }

        /* Cards */
        .card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--norman-blue);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title svg {
            width: 16px;
            height: 16px;
        }

        /* Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        /* Branding */
        .brand {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 16px;
        }

        .brand-logos {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .westral-logo {
            background: var(--westral-green);
            color: var(--westral-yellow);
            font-weight: 900;
            font-size: 14px;
            padding: 6px 16px;
            border-radius: 20px;
            border: 2px solid #006830;
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.3);
        }

        .norman-logo {
            color: var(--norman-blue);
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .norman-logo span {
            font-size: 8px;
            font-weight: 400;
            display: block;
            letter-spacing: 2px;
        }

        .brand h1 {
            color: var(--norman-blue);
            font-size: 16px;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--norman-blue);
            display: inline-block;
            padding-bottom: 4px;
        }

        /* Header row */
        .header-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .header-row input {
            text-align: center;
            padding: 10px 8px;
            font-size: 14px;
        }

        /* Custom Checkboxes - clear tick/no-tick on mobile */
        .custom-check {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .custom-check input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
            pointer-events: none;
        }

        .check-box {
            width: 22px;
            height: 22px;
            min-width: 22px;
            border: 2px solid #999;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            transition: background 0.15s, border-color 0.15s;
        }

        .check-box::after {
            content: '';
            display: none;
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 2.5px 2.5px 0;
            transform: rotate(45deg) translate(-1px, -1px);
        }

        .custom-check input[type="checkbox"]:checked+.check-box {
            background: var(--norman-blue);
            border-color: var(--norman-blue);
        }

        .custom-check input[type="checkbox"]:checked+.check-box::after {
            display: block;
        }

        .custom-check input[type="checkbox"]:checked+.check-box--danger {
            background: var(--danger);
            border-color: var(--danger);
        }

        /* Signature */
        .sig-box {
            border: 2px dashed var(--border);
            border-radius: 8px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 13px;
            cursor: pointer;
            background: #fafafa;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .sig-box canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .sig-box.has-sig {
            border-style: solid;
            border-color: var(--success);
        }

        .sig-box .sig-check {
            position: absolute;
            top: 6px;
            right: 6px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .sig-box.has-sig .sig-check {
            display: flex;
        }

        /* Fullscreen Signature Modal */
        .sig-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            flex-direction: column;
            padding: 20px;
            padding-top: env(safe-area-inset-top, 20px);
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        .sig-modal.active {
            display: flex;
        }

        .sig-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .sig-modal-header h3 {
            color: white;
            font-size: 18px;
            margin: 0;
        }

        .sig-modal-canvas-wrap {
            flex: 1;
            background: white;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            touch-action: none;
        }

        .sig-modal-canvas-wrap canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .sig-modal-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ccc;
            font-size: 16px;
            pointer-events: none;
        }

        .sig-modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .sig-modal-buttons .btn {
            flex: 1;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="app">
        <!-- VERSION BANNER -->
        <div id="versionBanner"
            style="background:#28a745; color:white; text-align:center; padding:8px; font-size:12px; font-weight:bold;">
            v2.0 - LAUNCH BUILD
        </div>
        <!-- ==================== PROJECT TAB ==================== -->
        <div id="v-project" class="view active">
            <div class="brand">
                <div class="brand-logos">
                    <div class="westral-logo">WESTRAL</div>
                    <div class="norman-logo">NORMAN<span>SHUTTERS · BLINDS · SHADES</span></div>
                </div>
                <h1>Technical Survey</h1>
            </div>

            <div class="header-row">
                <div><label class="label">Date</label><input type="text" id="jobDate" readonly></div>
                <div><label class="label">Reference #</label><input type="text" id="jobRef" placeholder="Quote/Ref"
                        maxlength="8" onfocus="verify(this)" onclick="verify(this)"></div>
                <div><label class="label">Surveyor</label><input type="text" id="surveyor" placeholder="Name"></div>
            </div>

            <!-- Hidden file input for camera/gallery on iPad/mobile -->
            <input type="file" id="scanInput" accept="image/*" capture="environment" style="display:none"
                onchange="handleScanFile(this)">
            <button class="btn btn-scan" onclick="triggerScan()" style="margin-bottom: 20px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                    <circle cx="12" cy="13" r="4" />
                </svg>
                Scan Order Form to Populate
            </button>

            <div class="card">
                <div class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                        <circle cx="12" cy="7" r="4" />
                    </svg> Customer Details</div>
                <input type="text" id="clientName" placeholder="Client Name" onfocus="verify(this)">
                <input type="text" id="clientAddr" placeholder="Installation Address" onfocus="verify(this)">
                <input type="tel" id="clientPhone" placeholder="Contact" onfocus="verify(this)">
                <input type="email" id="clientEmail" placeholder="Client Email" onfocus="verify(this)">
                <input type="email" id="consultantEmail" placeholder="Consultant Email (@westral.com.au)"
                    onfocus="verify(this)">
            </div>

            <div class="card">
                <div class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3" />
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l-.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z" />
                    </svg> Product Choices</div>
                <label class="label">Product Line</label>
                <select id="specProduct" onfocus="verify(this)" onclick="verify(this)"
                    onchange="updateProductOptions()">
                    <option value="Woodlore">Woodlore</option>
                    <option value="Woodlore Plus">Woodlore Plus</option>
                    <option value="Waterproof">WL+ Waterproof</option>
                    <option value="Brightwood">Brightwood</option>
                    <option value="Normandy">Normandy</option>
                </select>
                <div class="grid-2">
                    <div><label class="label">Mounting Method</label>
                        <select id="specMountMethod" onfocus="verify(this)" onclick="verify(this)">
                            <option>Hinged</option>
                            <option>Track</option>
                            <option>Bi-fold</option>
                        </select>
                    </div>
                    <div><label class="label">Mount</label>
                        <select id="specMount" onfocus="verify(this)" onclick="verify(this)">
                            <option>Recess</option>
                            <option>Face</option>
                        </select>
                    </div>
                </div>
                <div class="grid-2">
                    <div><label class="label">Frame</label>
                        <select id="specFrame" onfocus="verify(this)" onclick="verify(this)">
                            <option>Bullnose Z 38mm</option>
                            <option>Bullnose Z 50mm</option>
                            <option>Beaded Z 31mm</option>
                            <option>Beaded L Frame</option>
                            <option>Vintage L Frame</option>
                            <option>50mm Camber Deco</option>
                            <option>50mm Classic Deco</option>
                            <option>63mm Mission Deco</option>
                            <option>76mm Ridge Deco</option>
                            <option>Direct Mount</option>
                        </select>
                    </div>
                    <div><label class="label">Stile Design</label>
                        <select id="specStile" onfocus="verify(this)" onclick="verify(this)">
                            <option>Beaded Butt</option>
                            <option>Flat Butt</option>
                            <option>Astragal</option>
                            <option>Rabbet</option>
                        </select>
                    </div>
                </div>
                <div class="grid-2">
                    <div><label class="label">Color</label>
                        <select id="specColor" onfocus="verify(this)" onclick="verify(this)">
                            <option>001 Pure White</option>
                            <option>002 Extra White</option>
                            <option>003 Silk White</option>
                            <option>006 Pearl</option>
                            <option>032 Sea Mist</option>
                            <option>063 Decorator White</option>
                        </select>
                    </div>
                    <div><label class="label">Hinge Colour</label>
                        <select id="specHinge" onfocus="verify(this)" onclick="verify(this)">
                            <option>Pure White</option>
                            <option>Silk White</option>
                            <option>Bright White</option>
                            <option>Pearl</option>
                            <option>Stainless Steel</option>
                            <option>Bright Brass</option>
                            <option>Antique Brass</option>
                            <option>Black</option>
                            <option>Satin Nickel</option>
                        </select>
                    </div>
                </div>
                <div class="grid-2">
                    <div><label class="label">Tilt Rod</label>
                        <select id="specTilt" onfocus="verify(this)" onclick="verify(this)">
                            <option>EasyTilt</option>
                            <option>Traditional</option>
                        </select>
                    </div>
                    <div><label class="label">Blade</label>
                        <select id="specBlade" onfocus="verify(this)" onclick="verify(this)">
                            <option>47mm</option>
                            <option>63mm</option>
                            <option>76mm</option>
                            <option selected>89mm</option>
                            <option>114mm</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                    </svg> Comments / Special Instructions</div>
                <textarea id="jobComments" rows="3" placeholder="Enter any specific details..."></textarea>
            </div>



        </div>

        <!-- ==================== Fullscreen Signature Modal (GLOBAL - outside all tabs) ==================== -->
        <div class="sig-modal" id="sigModal">
            <div class="sig-modal-header">
                <h3 id="sigModalTitle">Customer Signature</h3>
                <button onclick="closeSigModal()"
                    style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">✕</button>
            </div>
            <div class="sig-modal-canvas-wrap" id="sigModalWrap">
                <span class="sig-modal-hint" id="sigModalHint">Sign here</span>
                <canvas id="sigModalCanvas"></canvas>
            </div>
            <div class="sig-modal-buttons">
                <button class="btn btn-outline" onclick="clearModalSig()" style="background: white;">Clear</button>
                <button class="btn btn-success" onclick="saveSigFromModal()">Done</button>
            </div>
        </div>

        <!-- ==================== SURVEY TAB ==================== -->
        <div id="v-survey" class="view">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <h2 style="margin: 0; border: none; padding: 0;">SURVEY</h2>
                <button class="btn btn-scan" onclick="capturePhoto()"
                    style="width: auto; padding: 8px 16px; font-size: 12px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                        <circle cx="12" cy="13" r="4" />
                    </svg>
                    Take Photo
                </button>
            </div>

            <!-- Room Tabs -->
            <div id="roomTabs" style="display: flex; gap: 4px; margin-bottom: 16px; flex-wrap: wrap;"></div>

            <!-- Room Spec Overrides -->
            <div id="roomSpecStrip" class="card" style="padding: 8px; background: #f0f4f8;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; font-size: 10px;">
                    <select id="roomProduct" class="room-spec-select" onchange="updateRoomSpec(this)"
                        onfocus="verify(this)">
                        <option>Woodlore</option>
                        <option>Woodlore Plus</option>
                        <option>Waterproof</option>
                        <option>Brightwood</option>
                        <option>Normandy</option>
                    </select>
                    <select id="roomMount" class="room-spec-select" onchange="updateRoomSpec(this)"
                        onfocus="verify(this)">
                        <option>Recess</option>
                        <option>Face</option>
                    </select>
                    <select id="roomMountMethod" class="room-spec-select" onchange="updateRoomSpec(this)"
                        onfocus="verify(this)">
                        <option>Hinged</option>
                        <option>Track</option>
                        <option>Bi-fold</option>
                    </select>
                    <select id="roomFrame" class="room-spec-select" onchange="updateRoomSpec(this)"
                        onfocus="verify(this)">
                        <option>Bullnose Z 38mm</option>
                        <option>Bullnose Z 50mm</option>
                        <option>Beaded Z 31mm</option>
                        <option>Beaded L Frame</option>
                        <option>Vintage L Frame</option>
                        <option>Direct Mount</option>
                        <option>50mm Camber Deco</option>
                        <option>50mm Classic Deco</option>
                        <option>63mm Mission Deco</option>
                        <option>76mm Ridge Deco</option>
                    </select>
                    <select id="roomStile" class="room-spec-select" onchange="updateRoomSpec(this)"
                        onfocus="verify(this)">
                        <option>Beaded Butt</option>
                        <option>Flat Butt</option>
                        <option>Astragal</option>
                        <option>Rabbet</option>
                    </select>
                    <select id="roomColor" class="room-spec-select" onchange="updateRoomSpec(this)"
                        onfocus="verify(this)">
                        <option>001 Pure White</option>
                        <option>002 Extra White</option>
                        <option>003 Silk White</option>
                        <option>006 Pearl</option>
                        <option>032 Sea Mist</option>
                        <option>063 Decorator's White</option>
                    </select>
                    <select id="roomHinge" class="room-spec-select" onchange="updateRoomSpec(this)"
                        onfocus="verify(this)">
                        <option>Pure White</option>
                        <option>Silk White</option>
                        <option>Pearl</option>
                        <option>Stainless Steel</option>
                        <option>Bright Brass</option>
                        <option>Antique Brass</option>
                        <option>Black</option>
                        <option>Satin Nickel</option>
                    </select>
                    <select id="roomTilt" class="room-spec-select" onchange="updateRoomSpec(this)"
                        onfocus="verify(this)">
                        <option>EasyTilt</option>
                        <option>Traditional</option>
                    </select>
                    <select id="roomBlade" class="room-spec-select" onchange="updateRoomSpec(this)"
                        onfocus="verify(this)">
                        <option>47mm</option>
                        <option>63mm</option>
                        <option>76mm</option>
                        <option>89mm</option>
                        <option>114mm</option>
                    </select>
                </div>
            </div>

            <style>
                .room-spec-select {
                    padding: 6px 4px;
                    border: 1px solid var(--border);
                    border-radius: 4px;
                    font-size: 10px;
                    background: white;
                    color: var(--norman-blue);
                    font-weight: 600;
                    cursor: pointer;
                    -webkit-appearance: none;
                    appearance: none;
                    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
                    background-repeat: no-repeat;
                    background-position: right 4px center;
                    padding-right: 16px;
                }

                .room-spec-select:focus {
                    border-color: var(--norman-blue);
                    outline: none;
                }
            </style>

            <!-- Room Name -->
            <input type="text" id="roomName" placeholder="Room / Location Name"
                style="text-transform: uppercase; font-weight: 700; text-align: center; font-size: 18px;"
                oninput="if(state.rooms[state.currentRoom]) { state.rooms[state.currentRoom].name = this.value; renderRoomTabs(); }">

            <!-- Panel Qty + Layout + Cover Strip -->
            <div class="grid-2" style="margin-bottom: 12px;">
                <div>
                    <label class="label">Panel Qty</label>
                    <input type="number" id="panelQty" value="2" min="1" max="8" onclick="this.select()"
                        onchange="updateMaxWidth()">
                </div>
                <div>
                    <label class="label">Layout</label>
                    <input type="text" id="layout" placeholder="L R" style="text-transform: uppercase;"
                        oninput="this.value = this.value.toUpperCase()">
                </div>
            </div>

            <!-- WIDTH Section -->
            <div class="card">
                <div class="card-title">Width (mm) <span id="maxWidthLabel"
                        style="margin-left: auto; font-size: 10px; color: var(--text-muted);">Max: 1828</span></div>
                <input type="number" id="mainWidth" placeholder="Width" style="font-size: 20px; text-align: center;"
                    oninput="validateWidth(this)">

                <!-- Posts/Breaks List -->
                <div class="card-title" style="margin-top: 12px;">Posts / Breaks</div>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <button id="postTypeBtn" onclick="cyclePostType()"
                        style="width: 100px; padding: 10px; background: var(--success); color: white; border: none; border-radius: 4px; font-weight: 700; cursor: pointer;">T-Post</button>
                    <input type="hidden" id="postType" value="T">
                    <input type="number" id="postPosition" placeholder="Position (mm)" style="flex: 1;"
                        onkeydown="if(event.key==='Enter'){addPost();event.preventDefault();}">
                    <input type="number" id="postDegrees" placeholder="Deg" style="width: 60px; display: none;"
                        onkeydown="if(event.key==='Enter'){addPost();event.preventDefault();}">
                    <button class="btn btn-primary" onclick="addPost()" style="width: 50px; padding: 10px;">+</button>
                </div>
                <div id="postsList" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
            </div>

            <!-- HEIGHT Section -->
            <div class="card">
                <div class="card-title">Height (mm)</div>
                <input type="number" id="mainHeight" placeholder="Height" style="font-size: 20px; text-align: center;"
                    oninput="validateHeight(this)">

                <!-- Cover Strip (Checkbox) -->
                <div style="margin-top: 8px; display: flex; align-items: center; justify-content: center;">
                    <label class="custom-check">
                        <input type="checkbox" id="coverStrip" checked>
                        <span class="check-box"></span>
                        Cover Strip
                    </label>
                </div>

                <!-- Dividers List -->
                <div class="card-title" style="margin-top: 12px;">Dividers / Mid Rails</div>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <input type="text" id="dividerValue" placeholder="Value (e.g. 800, 1/3, half)" style="flex: 1;"
                        onkeydown="if(event.key==='Enter'){addDivider();event.preventDefault();}">
                    <label class="custom-check" style="font-size: 12px; color: var(--danger);">
                        <input type="checkbox" id="dividerCritical">
                        <span class="check-box check-box--danger"></span>
                        CRITICAL
                    </label>
                    <button class="btn btn-primary" onclick="addDivider()"
                        style="width: 50px; padding: 10px;">+</button>
                </div>
                <div id="dividersList" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>

                <!-- Split -->
                <div style="margin-top: 12px;">
                    <label class="label">Split / Privacy Split</label>
                    <input type="text" id="splitValue" placeholder="e.g. 1/3 2/3, half, 800 bottom">
                </div>
            </div>

            <!-- PACKERS Section -->
            <div class="card">
                <div class="card-title">Packers</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 60px 50px; gap: 6px; margin-bottom: 8px;">
                    <input type="number" id="packerW" placeholder="W"
                        onkeydown="if(event.key==='Enter'){addPacker();event.preventDefault();}">
                    <input type="number" id="packerH" placeholder="H"
                        onkeydown="if(event.key==='Enter'){addPacker();event.preventDefault();}">
                    <input type="number" id="packerD" placeholder="D"
                        onkeydown="if(event.key==='Enter'){addPacker();event.preventDefault();}">
                    <input type="number" id="packerQty" placeholder="Qty" value="1"
                        onkeydown="if(event.key==='Enter'){addPacker();event.preventDefault();}">
                    <button class="btn btn-primary" onclick="addPacker()" style="padding: 10px;">+</button>
                </div>
                <div id="packersList" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
            </div>

            <!-- FRAME Diagram -->
            <div class="card">
                <div class="card-title">Frame Configuration</div>
                <style>
                    .frame-wrap {
                        position: relative;
                        width: 100%;
                        aspect-ratio: 4/3;
                        background: #fafafa;
                    }

                    .frame-side {
                        position: absolute;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 11px;
                        font-weight: 700;
                        color: white;
                        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
                        cursor: pointer;
                        -webkit-tap-highlight-color: transparent;
                        z-index: 2;
                        user-select: none;
                        letter-spacing: 0.5px;
                    }

                    .frame-side.frame-top {
                        top: 0;
                        left: 0;
                        right: 0;
                        height: 36px;
                    }

                    .frame-side.frame-bottom {
                        bottom: 0;
                        left: 0;
                        right: 0;
                        height: 36px;
                    }

                    .frame-side.frame-left {
                        top: 0;
                        left: 0;
                        bottom: 0;
                        width: 40px;
                    }

                    .frame-side.frame-right {
                        top: 0;
                        right: 0;
                        bottom: 0;
                        width: 40px;
                    }

                    /* Corner mitre lines */
                    .frame-corner {
                        position: absolute;
                        width: 50px;
                        height: 1px;
                        background: rgba(255, 255, 255, 0.6);
                        z-index: 3;
                        pointer-events: none;
                    }

                    .frame-corner-tl {
                        top: 0;
                        left: 0;
                        transform-origin: top left;
                        transform: rotate(37deg);
                    }

                    .frame-corner-tr {
                        top: 0;
                        right: 0;
                        transform-origin: top right;
                        transform: rotate(-37deg);
                    }

                    .frame-corner-bl {
                        bottom: 0;
                        left: 0;
                        transform-origin: bottom left;
                        transform: rotate(-37deg);
                    }

                    .frame-corner-br {
                        bottom: 0;
                        right: 0;
                        transform-origin: bottom right;
                        transform: rotate(37deg);
                    }

                    /* Photo area inside frame */
                    .frame-inner {
                        position: absolute;
                        top: 36px;
                        bottom: 36px;
                        left: 40px;
                        right: 40px;
                        border: 2px dashed var(--border);
                        border-radius: 4px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: var(--text-muted);
                        font-size: 12px;
                        cursor: pointer;
                        overflow: hidden;
                        background: white;
                    }
                </style>
                <div class="frame-wrap">
                    <div class="frame-side frame-top" onclick="cycleFrame('top')" id="frameTop">YES</div>
                    <div class="frame-side frame-bottom" onclick="cycleFrame('bottom')" id="frameBottom">YES</div>
                    <div class="frame-side frame-left" onclick="cycleFrame('left')" id="frameLeft">YES</div>
                    <div class="frame-side frame-right" onclick="cycleFrame('right')" id="frameRight">YES</div>
                    <!-- Corner mitre lines -->
                    <div class="frame-corner frame-corner-tl"></div>
                    <div class="frame-corner frame-corner-tr"></div>
                    <div class="frame-corner frame-corner-bl"></div>
                    <div class="frame-corner frame-corner-br"></div>
                    <!-- Photo area -->
                    <div class="frame-inner" id="photoArea" onclick="capturePhoto()">
                        <span id="photoPlaceholder">Tap to add photo</span>
                        <img id="roomPhoto" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                    </div>
                </div>
            </div>

            <!-- DRAWINGS Section -->
            <div class="card">
                <div class="card-title">Drawings</div>
                <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                    <button class="btn btn-primary" onclick="captureDrawing()"
                        style="flex: 1; font-size: 12px; padding: 12px 8px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                            <path
                                d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                            <circle cx="12" cy="13" r="4" />
                        </svg>
                        Capture Image
                    </button>
                    <button class="btn btn-outline" onclick="browseDrawing()"
                        style="flex: 1; font-size: 12px; padding: 12px 8px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                        </svg>
                        Browse Files
                    </button>
                </div>
                <input type="file" id="drawingCapture" accept="image/*" capture="environment" style="display:none;"
                    onchange="handleDrawingFile(this)">
                <input type="file" id="drawingBrowse" accept="image/*,.pdf" style="display:none;"
                    onchange="handleDrawingFile(this)">
                <div id="drawingsThumbs" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                <p id="drawingsEmpty"
                    style="font-size: 12px; color: var(--text-muted); text-align: center; margin: 4px 0 0;">No drawings
                    added</p>
            </div>

            <!-- Comments -->
            <div class="card">
                <div class="card-title">Room Notes</div>
                <textarea id="roomComments" rows="2" placeholder="Window-specific notes..."></textarea>
            </div>

            <!-- Save Button -->

        </div>


        <!-- ==================== SPECS TAB ==================== -->
        <div id="v-specs" class="view">
            <h2>SPECIFICATIONS</h2>

            <!-- Product Tabs - NOW RENDERED AT BOTTOM (hidden here) -->
            <div id="originalSpecTabs" style="display: none;">
                <button onclick="showSpec('wl')" id="spec-wl" class="spec-tab active">WL</button>
                <button onclick="showSpec('wlp')" id="spec-wlp" class="spec-tab">WL+</button>
                <button onclick="showSpec('wp')" id="spec-wp" class="spec-tab">WL+WP</button>
                <button onclick="showSpec('brite')" id="spec-brite" class="spec-tab">BRITE</button>
                <button onclick="showSpec('nmdy')" id="spec-nmdy" class="spec-tab">NMDY</button>
                <button onclick="showSpec('xref')" id="spec-xref" class="spec-tab">X REF</button>
                <button onclick="showSpec('tech')" id="spec-tech" class="spec-tab">TECH</button>
            </div>

            <style>
                .spec-tab {
                    padding: 8px 14px;
                    border: 2px solid var(--border);
                    background: white;
                    color: var(--text-muted);
                    border-radius: 8px;
                    font-size: 11px;
                    font-weight: 700;
                    cursor: pointer;
                }

                .spec-tab.active {
                    border-color: var(--norman-blue);
                    background: var(--norman-blue);
                    color: white;
                }

                .spec-table {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 12px;
                    margin-bottom: 16px;
                }

                .spec-table th {
                    background: var(--norman-blue);
                    color: white;
                    padding: 8px;
                    text-align: left;
                }

                .spec-table td {
                    border: 1px solid var(--border);
                    padding: 8px;
                }

                .spec-table tr:nth-child(even) {
                    background: #f8f9fa;
                }
            </style>

            <!-- WOODLORE -->
            <div id="specPanel-wl" class="spec-panel">
                <h3 style="color: var(--norman-blue); font-size: 16px; margin-bottom: 12px;">WOODLORE</h3>
                <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 12px;">Engineered Wood Composite
                    (MDF and LVL) that is VOC safe with an extruded medical grade Polypropylene Coating</p>

                <!-- Technical Specs Table -->
                <table class="spec-table">
                    <tr>
                        <th>Property</th>
                        <th>Specification</th>
                    </tr>
                    <tr>
                        <td>Motorised Option</td>
                        <td>Yes</td>
                    </tr>
                    <tr>
                        <td>Louver Shape</td>
                        <td>Elliptical</td>
                    </tr>
                    <tr>
                        <td>Louver Widths</td>
                        <td>47mm, 63mm, 76mm, 89mm, 114mm</td>
                    </tr>
                    <tr>
                        <td>Louver Depth Clearance</td>
                        <td>11.1mm (47), 19mm (63), 25.4mm (76), 31.7mm (89), 44.5mm (114)</td>
                    </tr>
                    <tr>
                        <td>Max Panel Width (47mm)</td>
                        <td>600mm</td>
                    </tr>
                    <tr>
                        <td>Max Panel Width (63mm)</td>
                        <td>750mm</td>
                    </tr>
                    <tr>
                        <td>Max Panel Width (76/89/114mm)</td>
                        <td><strong>914mm</strong></td>
                    </tr>
                    <tr>
                        <td>Max Hinge Bifold Width</td>
                        <td>600mm</td>
                    </tr>
                    <tr>
                        <td>Max Track Bifold Width</td>
                        <td>600mm</td>
                    </tr>
                    <tr>
                        <td>Max Panel Height</td>
                        <td><strong>2700mm</strong></td>
                    </tr>
                    <tr>
                        <td>Divider Rail Required</td>
                        <td>&gt; 1879mm</td>
                    </tr>
                    <tr>
                        <td>Height/Width Tolerance</td>
                        <td>±1.6mm</td>
                    </tr>
                    <tr>
                        <td>Stile Widths</td>
                        <td>50mm, 57mm</td>
                    </tr>
                    <tr>
                        <td>Stile Thickness</td>
                        <td>25.4mm</td>
                    </tr>
                    <tr>
                        <td>Rail Thickness</td>
                        <td>15.9mm</td>
                    </tr>
                    <tr>
                        <td>Standard Divider Rail Width</td>
                        <td>76.2mm</td>
                    </tr>
                    <tr>
                        <td>Stile Designs</td>
                        <td>Beaded & Flat Butt, Rabbet, Astragal (D-mould)</td>
                    </tr>
                    <tr>
                        <td>Tilt Rod Options</td>
                        <td>EasyTilt, Centre Tilt, Off-set Tilt</td>
                    </tr>
                    <tr>
                        <td>Max Louver per EasyTilt</td>
                        <td>24 (63), 19 (76), 16 (89), 12 (114) - Not available for 47mm</td>
                    </tr>
                    <tr>
                        <td>Frame to Panel on Hinge Side</td>
                        <td>2.54mm</td>
                    </tr>
                    <tr>
                        <td>Astragal Stile Gaps</td>
                        <td>LR 3mm, LL/RR 2.54mm</td>
                    </tr>
                    <tr>
                        <td>Rabbet Stile Overlap</td>
                        <td>LR 2.76mm, LLRR(LR) 2.22mm</td>
                    </tr>
                    <tr>
                        <td>Hinge Gap (Inside Mount)</td>
                        <td>3.2mm</td>
                    </tr>
                </table>

                <!-- Frame Options -->
                <table class="spec-table" style="margin-top: 12px;">
                    <tr>
                        <th colspan="2">Frame & Sill Options</th>
                    </tr>
                    <tr>
                        <td colspan="2">Vintage Hang Strip, Beaded L, Vintage L, Deep Plain L, Deep Bullnose Z, Crown Z,
                            Bel Air Z, Plain L, Bullnose Z, Serrate Z, Beaded Z, Tilt-Out Z, Ridge Deco, Camber Deco,
                            Mission Deco, Classic Deco, Designer Sill Cap, Chamfer T-posts, T-post with Insert, Deco
                            Sill Frame, Mission Sill Frame, Mission Sill Cap, 50/40mm Sill Plate</td>
                    </tr>
                    <tr>
                        <td>Frame Deduction (L frames)</td>
                        <td>3.2mm (1.6mm each side)</td>
                    </tr>
                    <tr>
                        <td>Frame Deduction (Z frames)</td>
                        <td>4mm (2mm each side)</td>
                    </tr>
                    <tr>
                        <td>Bay/Corner Window Posts</td>
                        <td>Available in standard and custom angles</td>
                    </tr>
                    <tr>
                        <td>Pre-drilled L & Z Frames</td>
                        <td>Available for inside mount only</td>
                    </tr>
                    <tr>
                        <td>Frame Extensions</td>
                        <td>Available</td>
                    </tr>
                    <tr>
                        <td>Combi-Joined Panels</td>
                        <td>Available</td>
                    </tr>
                </table>

                <!-- Colours (6 Standard) -->
                <table class="spec-table" style="margin-top: 12px;">
                    <tr>
                        <th colspan="3">Colours (6 Standard) - Custom NOT Available</th>
                    </tr>
                    <tr>
                        <td>001 Pure White</td>
                        <td>002 Extra White</td>
                        <td>003 Silk White</td>
                    </tr>
                    <tr>
                        <td>006 Pearl</td>
                        <td>032 Sea Mist</td>
                        <td>063 Decorator's White</td>
                    </tr>
                </table>

                <!-- Hinge Options -->
                <table class="spec-table" style="margin-top: 12px;">
                    <tr>
                        <th colspan="2">Hinge Types & Colours</th>
                    </tr>
                    <tr>
                        <td>Hinge Types</td>
                        <td>Self-mortise, Rabbet, L hinge, Pivot</td>
                    </tr>
                    <tr>
                        <td>Hinge Colours</td>
                        <td>Stainless Steel, painted colours without warranty</td>
                    </tr>
                    <tr>
                        <td>Magnets/Catches</td>
                        <td>Sleeve Ball Catch with Base Plate, Button Catch</td>
                    </tr>
                </table>

                <!-- Special Notes -->
                <div style="margin-top: 12px; padding: 8px; background: #fff3cd; border-radius: 4px; font-size: 11px;">
                    <strong>⚠️ Woodlore Limitations:</strong>
                    <ul style="margin: 4px 0 0 16px;">
                        <li>Custom colour: <strong>NOT available</strong></li>
                        <li>Special shapes: <strong>NOT available</strong></li>
                    </ul>
                </div>
            </div>

            <!-- WOODLORE PLUS -->
            <div id="specPanel-wlp" class="spec-panel" style="display: none;">
                <h3 style="color: var(--norman-blue); font-size: 16px; margin-bottom: 12px;">WOODLORE PLUS</h3>
                <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 12px;">Painted ABS louvers
                    (reinforced with LVL inserts) and Engineered Wood Composite stiles, rails and frames, finished with
                    paintable extruded Polypropylene Coating</p>

                <!-- Technical Specs Table -->
                <table class="spec-table">
                    <tr>
                        <th>Property</th>
                        <th>Specification</th>
                    </tr>
                    <tr>
                        <td>Motorised Option</td>
                        <td>Yes</td>
                    </tr>
                    <tr>
                        <td>Louver Shape</td>
                        <td>Elliptical</td>
                    </tr>
                    <tr>
                        <td>Louver Widths</td>
                        <td>47mm, 63mm, 76mm, 89mm, 114mm</td>
                    </tr>
                    <tr>
                        <td>Louver Depth Clearance</td>
                        <td>11.1mm (47), 19mm (63), 25.4mm (76), 31.7mm (89), 44.5mm (114)</td>
                    </tr>
                    <tr>
                        <td>Max Panel Width (47mm)</td>
                        <td>600mm</td>
                    </tr>
                    <tr>
                        <td>Max Panel Width (63mm/76mm)</td>
                        <td><strong>920mm</strong></td>
                    </tr>
                    <tr>
                        <td>Max Panel Width (89mm/114mm)</td>
                        <td><strong>920mm</strong></td>
                    </tr>
                    <tr>
                        <td>Max Hinge Bifold Width</td>
                        <td>600mm</td>
                    </tr>
                    <tr>
                        <td>Max Track Bifold Width</td>
                        <td>600mm</td>
                    </tr>
                    <tr>
                        <td>Max Panel Height</td>
                        <td><strong>3000mm</strong></td>
                    </tr>
                    <tr>
                        <td>Divider Rail Required</td>
                        <td>&gt; 1981mm</td>
                    </tr>
                    <tr>
                        <td>Height/Width Tolerance</td>
                        <td>±1.6mm</td>
                    </tr>
                    <tr>
                        <td>Stile Widths</td>
                        <td>50mm, 57mm</td>
                    </tr>
                    <tr>
                        <td>Stile Thickness</td>
                        <td>25.4mm</td>
                    </tr>
                    <tr>
                        <td>Rail Thickness</td>
                        <td>15.9mm</td>
                    </tr>
                    <tr>
                        <td>Standard Divider Rail Width</td>
                        <td>76.2mm</td>
                    </tr>
                    <tr>
                        <td>Stile Designs</td>
                        <td>Beaded & Flat Butt, Rabbet, Astragal (D-mould)</td>
                    </tr>
                    <tr>
                        <td>Tilt Rod Options</td>
                        <td>EasyTilt, Centre Tilt, Off-set Tilt</td>
                    </tr>
                    <tr>
                        <td>Max Louver per EasyTilt</td>
                        <td>24 (63), 19 (76), 16 (89), 12 (114) - Not available for 47mm</td>
                    </tr>
                    <tr>
                        <td>Frame to Panel on Hinge Side</td>
                        <td>2.54mm</td>
                    </tr>
                    <tr>
                        <td>Astragal Stile Gaps</td>
                        <td>LR 3mm, LL/RR 2.54mm</td>
                    </tr>
                    <tr>
                        <td>Rabbet Stile Overlap</td>
                        <td>LR 2.76mm, LLRR(LR) 2.22mm</td>
                    </tr>
                    <tr>
                        <td>Hinge Gap (Inside Mount)</td>
                        <td>3.2mm</td>
                    </tr>
                </table>

                <!-- Frame Options -->
                <table class="spec-table" style="margin-top: 12px;">
                    <tr>
                        <th colspan="2">Frame & Sill Options</th>
                    </tr>
                    <tr>
                        <td colspan="2">Vintage Hang Strip, Beaded L, Vintage L, Deep Plain L, Deep Bullnose Z, Crown Z,
                            Bel Air Z, Plain L, Bullnose Z, Serrate Z, Beaded Z, Tilt-Out Z, Ridge Deco, Camber Deco,
                            Mission Deco, Classic Deco, Designer Sill Cap, Chamfer T-posts, T-post with Insert, Deco
                            Sill Frame, Mission Sill Frame, Mission Sill Cap, 50/40mm Sill Plate</td>
                    </tr>
                    <tr>
                        <td>Frame Deduction (L frames)</td>
                        <td>3.2mm (1.6mm each side)</td>
                    </tr>
                    <tr>
                        <td>Frame Deduction (Z frames)</td>
                        <td>4mm (2mm each side)</td>
                    </tr>
                    <tr>
                        <td>Bay/Corner Window Posts</td>
                        <td>Available in standard and custom angles</td>
                    </tr>
                    <tr>
                        <td>Pre-drilled L & Z Frames</td>
                        <td>Available for inside mount only</td>
                    </tr>
                    <tr>
                        <td>Frame Extensions</td>
                        <td>Available</td>
                    </tr>
                    <tr>
                        <td>Combi-Joined Panels</td>
                        <td>Available</td>
                    </tr>
                </table>

                <!-- Colours -->
                <table class="spec-table" style="margin-top: 12px;">
                    <tr>
                        <th colspan="3">Colours (18 Standard)</th>
                    </tr>
                    <tr>
                        <td>001 Pure White</td>
                        <td>002 Extra White</td>
                        <td>003 Silk White</td>
                    </tr>
                    <tr>
                        <td>004 Bright White</td>
                        <td>006 Pearl</td>
                        <td>007 Ivory Lace</td>
                    </tr>
                    <tr>
                        <td>009 Creamy</td>
                        <td>012 Crisp Linen</td>
                        <td>019 String</td>
                    </tr>
                    <tr>
                        <td>032 Sea Mist</td>
                        <td>042 Hall Gray</td>
                        <td>063 Decorator's White</td>
                    </tr>
                    <tr>
                        <td>066 Winchester White 2010</td>
                        <td>075 Storm Gray</td>
                        <td>076 Aura White</td>
                    </tr>
                    <tr>
                        <td>080 Taupe Gray</td>
                        <td>090 Simply White</td>
                        <td>602 Dove</td>
                    </tr>
                </table>

                <!-- Hinge Options -->
                <table class="spec-table" style="margin-top: 12px;">
                    <tr>
                        <th colspan="2">Hinge Types & Colours</th>
                    </tr>
                    <tr>
                        <td>Hinge Types</td>
                        <td>Self-mortise, Rabbet, L hinge, Concealed hinge, Pivot</td>
                    </tr>
                    <tr>
                        <td>Hinge Colours</td>
                        <td>Stainless Steel, painted colours without warranty</td>
                    </tr>
                    <tr>
                        <td>Magnets/Catches</td>
                        <td>Sleeve Ball Catch with Base Plate, Button Catch</td>
                    </tr>
                </table>
            </div>

            <!-- WL+ WATERPROOF -->
            <!-- WL+ WATERPROOF -->
            <div id="specPanel-wp" class="spec-panel" style="display: none;">
                <h3 style="color: var(--norman-blue); font-size: 16px; margin-bottom: 12px;">WOODLORE PLUS WATERPROOF
                </h3>
                <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 12px;">Painted ABS louvers
                    (reinforced with LVL inserts) and painted solid ABS stiles, rails and frames, finished with
                    paintable extruded Polypropylene Coating</p>

                <!-- Technical Specs Table -->
                <table class="spec-table">
                    <tr>
                        <th>Property</th>
                        <th>Specification</th>
                    </tr>
                    <tr>
                        <td>Motorised Option</td>
                        <td>No</td>
                    </tr>
                    <tr>
                        <td>Louver Shape</td>
                        <td>Elliptical</td>
                    </tr>
                    <tr>
                        <td>Louver Widths</td>
                        <td>47mm, 63mm, 76mm, 89mm, 114mm</td>
                    </tr>
                    <tr>
                        <td>Louver Depth Clearance</td>
                        <td>11.1mm (47), 19mm (63), 25.4mm (76), 31.7mm (89), 44.5mm (114)</td>
                    </tr>
                    <tr>
                        <td>Max Panel Width (47mm)</td>
                        <td>610mm</td>
                    </tr>
                    <tr>
                        <td>Max Panel Width (63mm/76mm)</td>
                        <td><strong>800mm</strong></td>
                    </tr>
                    <tr>
                        <td>Max Panel Width (89mm/114mm)</td>
                        <td><strong>920mm</strong></td>
                    </tr>
                    <tr>
                        <td>Max Hinge Bifold Width</td>
                        <td>600mm</td>
                    </tr>
                    <tr>
                        <td>Max Track Bifold Width</td>
                        <td>600mm</td>
                    </tr>
                    <tr>
                        <td>Max Panel Height</td>
                        <td><strong>3000mm</strong></td>
                    </tr>
                    <tr>
                        <td>Divider Rail Required</td>
                        <td>&gt; 1828mm</td>
                    </tr>
                    <tr>
                        <td>Height/Width Tolerance</td>
                        <td>±1.6mm</td>
                    </tr>
                    <tr>
                        <td>Stile Widths</td>
                        <td>50mm, 57mm</td>
                    </tr>
                    <tr>
                        <td>Stile Thickness</td>
                        <td>25.4mm</td>
                    </tr>
                    <tr>
                        <td>Rail Thickness</td>
                        <td>20mm</td>
                    </tr>
                    <tr>
                        <td>Standard Divider Rail Width</td>
                        <td>76.2mm</td>
                    </tr>
                    <tr>
                        <td>Stile Designs</td>
                        <td>Beaded & Flat Butt, Rabbet, Astragal (D-mould)</td>
                    </tr>
                    <tr>
                        <td>Tilt Rod Options</td>
                        <td>EasyTilt, Centre Tilt, Off-set Tilt</td>
                    </tr>
                    <tr>
                        <td>Max Louver per EasyTilt</td>
                        <td>24 (63), 19 (76), 16 (89), 12 (114) - Not available for 47mm</td>
                    </tr>
                    <tr>
                        <td>Frame to Panel on Hinge Side</td>
                        <td>2.54mm</td>
                    </tr>
                    <tr>
                        <td>Astragal Stile Gaps</td>
                        <td>LR 3mm, LL/RR 2.54mm</td>
                    </tr>
                    <tr>
                        <td>Rabbet Stile Overlap</td>
                        <td>LR 2.76mm, LLRR(LR) 2.22mm</td>
                    </tr>
                    <tr>
                        <td>Hinge Gap (Inside Mount)</td>
                        <td>3.2mm</td>
                    </tr>
                </table>

                <!-- Frame Options -->
                <table class="spec-table" style="margin-top: 12px;">
                    <tr>
                        <th colspan="2">Frame & Sill Options</th>
                    </tr>
                    <tr>
                        <td colspan="2">Vintage Hang Strip, Beaded L, Vintage L, Deep Plain L, Deep Bullnose Z, Crown Z,
                            Bel Air Z, Plain L, Bullnose Z, Serrate Z, Beaded Z, Tilt-Out Z, Ridge Deco, Camber Deco,
                            Mission Deco, Classic Deco, Designer Sill Cap, Chamfer T-posts, T-post with Insert, Deco
                            Sill Frame, Mission Sill Frame, Mission Sill Cap, 50/40mm Sill Plate</td>
                    </tr>
                    <tr>
                        <td>Frame Deduction (L frames)</td>
                        <td>3.2mm (1.6mm each side)</td>
                    </tr>
                    <tr>
                        <td>Frame Deduction (Z frames)</td>
                        <td>4mm (2mm each side)</td>
                    </tr>
                    <tr>
                        <td>Bay/Corner Window Posts</td>
                        <td>Available in standard and custom angles</td>
                    </tr>
                    <tr>
                        <td>Pre-drilled L & Z Frames</td>
                        <td>Available for inside mount only</td>
                    </tr>
                    <tr>
                        <td>Frame Extensions</td>
                        <td>Available</td>
                    </tr>
                    <tr>
                        <td>Combi-Joined Panels</td>
                        <td>Available</td>
                    </tr>
                </table>

                <!-- Colours -->
                <table class="spec-table" style="margin-top: 12px;">
                    <tr>
                        <th colspan="3">Colours (18 Standard)</th>
                    </tr>
                    <tr>
                        <td>001 Pure White</td>
                        <td>002 Extra White</td>
                        <td>003 Silk White</td>
                    </tr>
                    <tr>
                        <td>004 Bright White</td>
                        <td>006 Pearl</td>
                        <td>007 Ivory Lace</td>
                    </tr>
                    <tr>
                        <td>009 Creamy</td>
                        <td>012 Crisp Linen</td>
                        <td>019 String</td>
                    </tr>
                    <tr>
                        <td>032 Sea Mist</td>
                        <td>042 Hall Gray</td>
                        <td>063 Decorator's White</td>
                    </tr>
                    <tr>
                        <td>066 Winchester White</td>
                        <td>075 Storm Gray</td>
                        <td>076 Aura White</td>
                    </tr>
                    <tr>
                        <td>080 Taupe Gray</td>
                        <td>090 Simply White</td>
                        <td>602 Dove</td>
                    </tr>
                </table>

                <!-- Hinge Options -->
                <table class="spec-table" style="margin-top: 12px;">
                    <tr>
                        <th colspan="2">Hinge Types & Colours</th>
                    </tr>
                    <tr>
                        <td>Hinge Types</td>
                        <td>Self-mortise, Rabbet, L hinge, Concealed hinge, Pivot</td>
                    </tr>
                    <tr>
                        <td>Hinge Colours</td>
                        <td>Stainless Steel (Recommended for waterproof areas)</td>
                    </tr>
                    <tr>
                        <td>Magnets/Catches</td>
                        <td>Sleeve Ball Catch with Base Plate, Button Catch</td>
                    </tr>
                </table>
            </div>

            <!-- BRIGHTWOOD -->
            <div id="specPanel-brite" class="spec-panel" style="display: none;">
                <h3 style="color: var(--norman-blue); font-size: 16px; margin-bottom: 12px;">BRIGHTWOOD</h3>
                <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 12px;">Painted Premium Hardwood
                    louvers and rails with ABS coated hardwood stile, mounted on EWC frames</p>

                <!-- Technical Specs Table -->
                <table class="spec-table">
                    <tr>
                        <th>Property</th>
                        <th>Specification</th>
                    </tr>
                    <tr>
                        <td>Motorised Option</td>
                        <td>Yes</td>
                    </tr>
                    <tr>
                        <td>Louver Shape</td>
                        <td>Elliptical</td>
                    </tr>
                    <tr>
                        <td>Louver Widths</td>
                        <td>47mm, 63mm, 76mm, 89mm, 114mm</td>
                    </tr>
                    <tr>
                        <td>Louver Depth Clearance</td>
                        <td>11.1mm (47), 19mm (63), 25.4mm (76), 31.7mm (89), 44.5mm (114)</td>
                    </tr>
                    <tr>
                        <td>Max Panel Width (47mm)</td>
                        <td>762mm</td>
                    </tr>
                    <tr>
                        <td>Max Panel Width (63mm/76mm)</td>
                        <td><strong>920mm</strong></td>
                    </tr>
                    <tr>
                        <td>Max Panel Width (89mm/114mm)</td>
                        <td><strong>1066mm</strong></td>
                    </tr>
                    <tr>
                        <td>Max Hinge Bifold Width</td>
                        <td>700mm</td>
                    </tr>
                    <tr>
                        <td>Max Track Bifold Width</td>
                        <td>700mm</td>
                    </tr>
                    <tr>
                        <td>Max Track Multi Panel Width</td>
                        <td>550mm</td>
                    </tr>
                    <tr>
                        <td>Max Panel Height</td>
                        <td><strong>3000mm</strong></td>
                    </tr>
                    <tr>
                        <td>Divider Rail Required</td>
                        <td>&gt; 1981mm</td>
                    </tr>
                    <tr>
                        <td>Height/Width Tolerance</td>
                        <td>±1.6mm</td>
                    </tr>
                    <tr>
                        <td>Stile Widths</td>
                        <td>50mm, 57mm</td>
                    </tr>
                    <tr>
                        <td>Stile Thickness</td>
                        <td>25.4mm</td>
                    </tr>
                    <tr>
                        <td>Rail Thickness</td>
                        <td>20mm</td>
                    </tr>
                    <tr>
                        <td>Standard Divider Rail Width</td>
                        <td>76.2mm</td>
                    </tr>
                    <tr>
                        <td>Stile Designs</td>
                        <td>Beaded & Flat Butt, Rabbet, Astragal (D-mould)</td>
                    </tr>
                    <tr>
                        <td>Tilt Rod Options</td>
                        <td>EasyTilt, Centre Tilt, Off-set Tilt</td>
                    </tr>
                    <tr>
                        <td>Max Louver per EasyTilt</td>
                        <td>24 (63), 19 (76), 16 (89), 12 (114) - Not available for 47mm</td>
                    </tr>
                    <tr>
                        <td>Frame to Panel on Hinge Side</td>
                        <td>2.54mm</td>
                    </tr>
                    <tr>
                        <td>Astragal Stile Gaps</td>
                        <td>LR 3mm, LL/RR 2.54mm</td>
                    </tr>
                    <tr>
                        <td>Rabbet Stile Overlap</td>
                        <td>LR 2.76mm, LLRR(LR) 2.22mm</td>
                    </tr>
                    <tr>
                        <td>Hinge Gap (Inside Mount)</td>
                        <td>3.2mm</td>
                    </tr>
                </table>

                <!-- Frame Options -->
                <table class="spec-table" style="margin-top: 12px;">
                    <tr>
                        <th colspan="2">Frame & Sill Options</th>
                    </tr>
                    <tr>
                        <td colspan="2">Vintage Hang Strip, Beaded L, Vintage L, Deep Plain L, Deep Bullnose Z, Crown Z,
                            Bel Air Z, Plain L, Bullnose Z, Serrate Z, Beaded Z, Tilt-Out Z, Ridge Deco, Camber Deco,
                            Mission Deco, Classic Deco, Designer Sill Cap, Chamfer T-posts, T-post with Insert, Deco
                            Sill Frame, Mission Sill Frame, Mission Sill Cap, 50/40mm Sill Plate</td>
                    </tr>
                    <tr>
                        <td>Frame Deduction (L frames)</td>
                        <td>3.2mm (1.6mm each side)</td>
                    </tr>
                    <tr>
                        <td>Frame Deduction (Z frames)</td>
                        <td>4mm (2mm each side)</td>
                    </tr>
                    <tr>
                        <td>Bay/Corner Window Posts</td>
                        <td>Available in standard and custom angles</td>
                    </tr>
                    <tr>
                        <td>Pre-drilled L & Z Frames</td>
                        <td>Available for inside mount only</td>
                    </tr>
                    <tr>
                        <td>Frame Extensions</td>
                        <td>Available</td>
                    </tr>
                    <tr>
                        <td>Combi-Joined Panels</td>
                        <td>Available</td>
                    </tr>
                </table>

                <!-- Colours -->
                <table class="spec-table" style="margin-top: 12px;">
                    <tr>
                        <th colspan="3">Colours (18 Standard + Custom)</th>
                    </tr>
                    <tr>
                        <td>001 Pure White</td>
                        <td>002 Extra White</td>
                        <td>003 Silk White</td>
                    </tr>
                    <tr>
                        <td>004 Bright White</td>
                        <td>006 Pearl</td>
                        <td>007 Ivory Lace</td>
                    </tr>
                    <tr>
                        <td>009 Creamy</td>
                        <td>012 Crisp Linen</td>
                        <td>019 String</td>
                    </tr>
                    <tr>
                        <td>032 Sea Mist</td>
                        <td>042 Hall Gray</td>
                        <td>063 Decorator's White</td>
                    </tr>
                    <tr>
                        <td>066 Winchester White 2010</td>
                        <td>075 Storm Gray</td>
                        <td>076 Aura White</td>
                    </tr>
                    <tr>
                        <td>080 Taupe Gray</td>
                        <td>090 Simply White</td>
                        <td>602 Dove</td>
                    </tr>
                    <tr>
                        <td colspan="3"><strong>Custom Colour:</strong> Available in solid colour only (no dark colours)
                        </td>
                    </tr>
                </table>

                <!-- Hinge Options -->
                <table class="spec-table" style="margin-top: 12px;">
                    <tr>
                        <th colspan="2">Hinge Types & Colours</th>
                    </tr>
                    <tr>
                        <td>Hinge Types</td>
                        <td>Self-mortise, Rabbet, L hinge, Concealed hinge, Pivot</td>
                    </tr>
                    <tr>
                        <td>Hinge Colours</td>
                        <td>Pure White, Silk White, Pearl, Bisque, Crisp Linen, String, Sea Mist, Stone Gray, Brown
                            Gray, Taupe Gray, Bright Brass, Antique Brass, Black, Stainless Steel, Nickel Plated,
                            Brushed Nickel</td>
                    </tr>
                    <tr>
                        <td>Magnets/Catches</td>
                        <td>Sleeve Ball Catch with Base Plate, Button Catch</td>
                    </tr>
                </table>
            </div>

            <!-- NORMANDY -->
            <div id="specPanel-nmdy" class="spec-panel" style="display: none;">
                <h3 style="color: var(--norman-blue); font-size: 16px; margin-bottom: 12px;">NORMANDY (Premium Hardwood)
                </h3>
                <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 12px;">Premium Hardwood panels and
                    frames. Phoenixwood used for stain colours.</p>

                <!-- Technical Specs Table -->
                <table class="spec-table">
                    <tr>
                        <th>Property</th>
                        <th>Specification</th>
                    </tr>
                    <tr>
                        <td>Motorised Option</td>
                        <td>Yes</td>
                    </tr>
                    <tr>
                        <td>Louver Shape</td>
                        <td>Elliptical</td>
                    </tr>
                    <tr>
                        <td>Louver Widths</td>
                        <td>47mm, 63mm, 76mm, 89mm, 114mm</td>
                    </tr>
                    <tr>
                        <td>Louver Depth Clearance</td>
                        <td>11.1mm (47), 19mm (63), 25.4mm (76), 31.7mm (89), 44.5mm (114)</td>
                    </tr>
                    <tr>
                        <td>Max Panel Width (47mm)</td>
                        <td>762mm</td>
                    </tr>
                    <tr>
                        <td>Max Panel Width (63mm/76mm)</td>
                        <td><strong>920mm</strong></td>
                    </tr>
                    <tr>
                        <td>Max Panel Width (89mm/114mm)</td>
                        <td><strong>1095mm</strong></td>
                    </tr>
                    <tr>
                        <td>Max Hinge Bifold Width</td>
                        <td>700mm</td>
                    </tr>
                    <tr>
                        <td>Max Track Bifold Width</td>
                        <td>700mm</td>
                    </tr>
                    <tr>
                        <td>Max Track Multi Panel Width</td>
                        <td>550mm</td>
                    </tr>
                    <tr>
                        <td>Max Panel Height</td>
                        <td><strong>3000mm</strong></td>
                    </tr>
                    <tr>
                        <td>Divider Rail Required</td>
                        <td>&gt; 1981mm</td>
                    </tr>
                    <tr>
                        <td>Height/Width Tolerance</td>
                        <td>±1.6mm</td>
                    </tr>
                    <tr>
                        <td>Stile Widths</td>
                        <td>50mm, 57mm</td>
                    </tr>
                    <tr>
                        <td>Stile Thickness</td>
                        <td>25.4mm</td>
                    </tr>
                    <tr>
                        <td>Rail Thickness</td>
                        <td>20mm</td>
                    </tr>
                    <tr>
                        <td>Standard Divider Rail Width</td>
                        <td>76.2mm</td>
                    </tr>
                    <tr>
                        <td>Stile Designs</td>
                        <td>Beaded & Flat Butt, Rabbet, Astragal (D-mould)</td>
                    </tr>
                    <tr>
                        <td>Tilt Rod Options</td>
                        <td>EasyTilt, Centre Tilt, Off-set Tilt</td>
                    </tr>
                    <tr>
                        <td>Max Louver per EasyTilt</td>
                        <td>24 (63), 19 (76), 16 (89), 12 (114) - Not available for 47mm</td>
                    </tr>
                    <tr>
                        <td>Frame to Panel on Hinge Side</td>
                        <td>2.54mm</td>
                    </tr>
                    <tr>
                        <td>Astragal Stile Gaps</td>
                        <td>LR 3mm, LL/RR 2.54mm</td>
                    </tr>
                    <tr>
                        <td>Rabbet Stile Overlap</td>
                        <td>LR 2.76mm, LLRR(LR) 2.22mm</td>
                    </tr>
                    <tr>
                        <td>Hinge Gap (Inside Mount)</td>
                        <td>3.2mm</td>
                    </tr>
                </table>

                <!-- Frame Options -->
                <table class="spec-table" style="margin-top: 12px;">
                    <tr>
                        <th colspan="2">Frame & Sill Options</th>
                    </tr>
                    <tr>
                        <td colspan="2">Vintage Hang Strip, Beaded L, Vintage L, Deep Plain L, Deep Bullnose Z, Crown Z,
                            Bel Air Z, Plain L, Bullnose Z, Serrate Z, Beaded Z, Tilt-Out Z, Ridge Deco, Camber Deco,
                            Mission Deco, Classic Deco, Designer Sill Cap, Chamfer T-posts, T-post with Insert, Deco
                            Sill Frame, Mission Sill Frame, Mission Sill Cap, 50/40mm Sill Plate</td>
                    </tr>
                    <tr>
                        <td>Frame Deduction (L frames)</td>
                        <td>3.2mm (1.6mm each side)</td>
                    </tr>
                    <tr>
                        <td>Frame Deduction (Z frames)</td>
                        <td>4mm (2mm each side)</td>
                    </tr>
                    <tr>
                        <td>Bay/Corner Window Posts</td>
                        <td>Available in standard and custom angles</td>
                    </tr>
                    <tr>
                        <td>Pre-drilled L & Z Frames</td>
                        <td>Available for inside mount only</td>
                    </tr>
                    <tr>
                        <td>Frame Extensions</td>
                        <td>Available</td>
                    </tr>
                    <tr>
                        <td>Combi-Joined Panels</td>
                        <td>Available</td>
                    </tr>
                </table>

                <!-- Colours -->
                <table class="spec-table" style="margin-top: 12px;">
                    <tr>
                        <th colspan="3">Colours (50+ Options)</th>
                    </tr>
                    <tr>
                        <td colspan="3" style="background:var(--bg-light); font-weight:600;">Standard Painted</td>
                    </tr>
                    <tr>
                        <td>001 Pure White</td>
                        <td>002 Extra White</td>
                        <td>003 Silk White</td>
                    </tr>
                    <tr>
                        <td>004 Bright White</td>
                        <td>006 Pearl</td>
                        <td>007 Ivory Lace</td>
                    </tr>
                    <tr>
                        <td>009 Creamy</td>
                        <td>012 Crisp Linen</td>
                        <td>017 Gray Black</td>
                    </tr>
                    <tr>
                        <td>019 String</td>
                        <td>030 Moondust</td>
                        <td>032 Sea Mist</td>
                    </tr>
                    <tr>
                        <td>042 Hall Gray</td>
                        <td>049 Stone Gray</td>
                        <td>053 Clay</td>
                    </tr>
                    <tr>
                        <td>...and many more</td>
                        <td>836 Classic Black</td>
                        <td>602 Dove</td>
                    </tr>

                    <tr>
                        <td colspan="3" style="background:var(--bg-light); font-weight:600;">Stain Colours (Phoenixwood)
                        </td>
                    </tr>
                    <tr>
                        <td>110 Limed White</td>
                        <td>200 Natural</td>
                        <td>202 Golden Oak</td>
                    </tr>
                    <tr>
                        <td>212 Dark Teak</td>
                        <td>221 Black Walnut</td>
                        <td>227 Red Oak</td>
                    </tr>
                    <tr>
                        <td>242 Auburn</td>
                        <td>246 Matte Black</td>
                        <td>862 French Oak</td>
                    </tr>

                    <tr>
                        <td colspan="3" style="background:var(--bg-light); font-weight:600;">LUXE Colours</td>
                    </tr>
                    <tr>
                        <td>1003 White Matte</td>
                        <td>1109 Silk Gray</td>
                        <td>1203 Black LUXE</td>
                    </tr>

                    <tr>
                        <td colspan="3"><strong>Custom Colour:</strong> Available in solid colour only (not dark)</td>
                    </tr>
                </table>

                <!-- Hinge Options -->
                <table class="spec-table" style="margin-top: 12px;">
                    <tr>
                        <th colspan="2">Hinge Types & Colours</th>
                    </tr>
                    <tr>
                        <td>Hinge Types</td>
                        <td>Self-mortise, Rabbet, L hinge, Concealed hinge, Pivot</td>
                    </tr>
                    <tr>
                        <td>Hinge Colours</td>
                        <td>Pure White, Silk White, Pearl, Bisque, Crisp Linen, String, Sea Mist, Stone Gray, Brown
                            Gray, Taupe Gray, Bright Brass, Antique Brass, Black, Stainless Steel, Nickel Plated,
                            Brushed Nickel</td>
                    </tr>
                    <tr>
                        <td>Magnets/Catches</td>
                        <td>Sleeve Ball Catch with Base Plate, Button Catch</td>
                    </tr>
                </table>
            </div>

            <!-- X REF (Cross Reference) -->
            <div id="specPanel-xref" class="spec-panel" style="display: none;">
                <h3 style="color: var(--norman-blue); font-size: 16px; margin-bottom: 12px;">CROSS REFERENCE</h3>
                <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 12px;">Panel Size Limitations (mm) -
                    2024 Specification Summary</p>
                <div style="overflow-x: auto;">
                    <table class="spec-table" style="font-size: 10px;">
                        <tr>
                            <th>Configuration</th>
                            <th>Louver</th>
                            <th>WL</th>
                            <th>WL+</th>
                            <th>WL+WP</th>
                            <th>BRITE</th>
                            <th>NMDY</th>
                        </tr>
                        <tr>
                            <td>Min Width</td>
                            <td>All</td>
                            <td>152.4</td>
                            <td>152.4</td>
                            <td>152.4</td>
                            <td>152.4</td>
                            <td>152.4</td>
                        </tr>
                        <tr>
                            <td>Min Height</td>
                            <td>All</td>
                            <td>250</td>
                            <td>250</td>
                            <td>250</td>
                            <td>250</td>
                            <td>250</td>
                        </tr>
                        <tr>
                            <td>Divider Rail</td>
                            <td>All</td>
                            <td>&gt;1879</td>
                            <td>&gt;1981</td>
                            <td>&gt;1828</td>
                            <td>&gt;1981</td>
                            <td>&gt;1981</td>
                        </tr>
                        <tr>
                            <td>Max Width</td>
                            <td>47mm</td>
                            <td>600</td>
                            <td>600</td>
                            <td>610</td>
                            <td>762</td>
                            <td>762</td>
                        </tr>
                        <tr>
                            <td>Max Width</td>
                            <td>63mm</td>
                            <td>750</td>
                            <td>800</td>
                            <td>800</td>
                            <td>920</td>
                            <td>920</td>
                        </tr>
                        <tr>
                            <td>Max Width</td>
                            <td>76mm</td>
                            <td>914</td>
                            <td>920</td>
                            <td>920</td>
                            <td>920</td>
                            <td>920</td>
                        </tr>
                        <tr>
                            <td>Max Width</td>
                            <td>89/114</td>
                            <td>914</td>
                            <td>920</td>
                            <td>920</td>
                            <td>1066</td>
                            <td>1095</td>
                        </tr>
                        <tr>
                            <td>Max Height</td>
                            <td>All</td>
                            <td><strong>2700</strong></td>
                            <td><strong>3000</strong></td>
                            <td><strong>3000</strong></td>
                            <td><strong>3000</strong></td>
                            <td><strong>3000</strong></td>
                        </tr>
                        <tr>
                            <td>Bifold Hinge</td>
                            <td>All</td>
                            <td>600</td>
                            <td>610</td>
                            <td>610</td>
                            <td>700</td>
                            <td>700</td>
                        </tr>
                        <tr>
                            <td>Bifold Track</td>
                            <td>All</td>
                            <td>600</td>
                            <td>600</td>
                            <td>600</td>
                            <td>700</td>
                            <td>700</td>
                        </tr>
                    </table>
                </div>
                <table class="spec-table" style="margin-top: 16px; font-size: 11px;">
                    <tr>
                        <th>Feature</th>
                        <th>WL</th>
                        <th>WL+</th>
                        <th>WL+WP</th>
                        <th>BRITE</th>
                        <th>NMDY</th>
                    </tr>
                    <tr>
                        <td>Painted Colours</td>
                        <td>5</td>
                        <td>18</td>
                        <td>18</td>
                        <td>18</td>
                        <td>24</td>
                    </tr>
                    <tr>
                        <td>Stained Colours</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>18</td>
                    </tr>
                    <tr>
                        <td>LUXE Colours</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                        <td>6</td>
                    </tr>
                    <tr>
                        <td>Motorised</td>
                        <td>Yes</td>
                        <td>Yes</td>
                        <td>No</td>
                        <td>Yes</td>
                        <td>Yes</td>
                    </tr>
                    <tr>
                        <td>Special Shapes</td>
                        <td>-</td>
                        <td>Yes*</td>
                        <td>Yes*</td>
                        <td>Yes*</td>
                        <td>Yes</td>
                    </tr>
                </table>
                <p style="font-size: 10px; color: var(--text-muted); margin-top: 8px;">* Special shapes charged at
                    Normandy m² rate</p>
            </div>

            <!-- TECH (Technical Info - PDF Brochure Viewer) -->
            <div id="specPanel-tech" class="spec-panel" style="display: none;">
                <h3 style="color: var(--norman-blue); font-size: 16px; margin-bottom: 12px;">NORMAN SHUTTER BROCHURE
                </h3>
                <div id="pdfLoading" style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <div
                        style="width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--norman-blue); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px;">
                    </div>
                    <p style="font-size: 14px;">Loading Brochure...</p>
                </div>
                <style>
                    @keyframes spin {
                        to {
                            transform: rotate(360deg);
                        }
                    }

                    #pdfContainer {
                        overflow-y: auto;
                        -webkit-overflow-scrolling: touch;
                        max-height: calc(100vh - 260px);
                        border-radius: 8px;
                        background: #e0e0e0;
                        touch-action: pan-x pan-y pinch-zoom;
                    }

                    #pdfContainer canvas {
                        display: block;
                        width: 100%;
                        height: auto;
                        margin-bottom: 4px;
                        background: white;
                        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
                    }
                </style>
                <div id="pdfContainer" style="display: none;"></div>
                <p id="pdfError"
                    style="display: none; text-align: center; padding: 20px; color: var(--danger); font-size: 13px;">
                </p>
                <p style="font-size: 11px; color: var(--text-muted); text-align: center; margin-top: 8px;">Tap any page
                    to zoom in</p>
            </div>

            <!-- Fullscreen Brochure Viewer -->
            <div id="brochureViewer"
                style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.95); z-index:2000; flex-direction:column;">
                <div
                    style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px; padding-top: max(12px, env(safe-area-inset-top));">
                    <span style="color:white; font-size:14px; font-weight:600;" id="brochurePageLabel">Page 1</span>
                    <button onclick="closeBrochureViewer()"
                        style="background:none; border:none; color:white; font-size:28px; cursor:pointer; padding:4px 8px;">✕</button>
                </div>
                <div id="brochureViewerContent"
                    style="flex:1; overflow:auto; -webkit-overflow-scrolling:touch; display:flex; align-items:flex-start; justify-content:center; padding:8px;">
                    <img id="brochureViewerImg"
                        style="max-width:none; width:100%; touch-action:pinch-zoom pan-x pan-y;" />
                </div>
            </div>
        </div>

        <!-- ==================== REVIEW TAB ==================== -->
        <div id="v-review" class="view">
            <h2>ORDER SPREADSHEET</h2>

            <!-- Spreadsheet Container -->
            <div class="card" style="padding: 0; overflow: hidden;">
                <div style="background: var(--norman-blue); color: white; padding: 12px 16px; font-weight: 600;">
                    Office Order Format
                </div>

                <!-- Compact Client Info Header -->
                <div
                    style="padding: 8px 12px; background: #e3f2fd; border-bottom: 2px solid var(--norman-blue); font-size: 11px; display: grid; grid-template-columns: 1fr 1fr; gap: 4px 16px;">
                    <div><strong>Client:</strong> <span id="ssClientName">-</span></div>
                    <div><strong>Ref:</strong> <span id="ssJobRef">-</span></div>
                    <div><strong>Address:</strong> <span id="ssClientAddr">-</span></div>
                    <div><strong>Surveyor:</strong> <span id="ssSurveyor">-</span></div>
                    <div><strong>Phone:</strong> <span id="ssClientPhone">-</span> &nbsp; <strong>Email:</strong> <span
                            id="ssClientEmail">-</span></div>
                    <div><strong>Date:</strong> <span id="ssJobDate">-</span></div>
                    <div style="grid-column: 1 / -1;"><strong>Consultant:</strong> <span id="ssConsultant">-</span>
                    </div>
                </div>

                <!-- Single Scrollable Order Sheet -->
                <div style="overflow-x: auto; overflow-y: auto; max-height: 450px; -webkit-overflow-scrolling: touch;">
                    <table class="spec-table" id="ssMainTable"
                        style="font-size: 10px; margin: 0; min-width: 2400px; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; z-index: 10;">
                            <tr style="background: var(--norman-blue); color: white;">
                                <th
                                    style="position: sticky; left: 0; z-index: 11; background: var(--norman-blue); min-width: 80px;">
                                    Room</th>
                                <th style="min-width: 80px;">Product</th>
                                <th style="min-width: 75px;">Method</th>
                                <th style="min-width: 70px;">Colour</th>
                                <th style="min-width: 65px;">Hinge</th>
                                <th style="min-width: 65px;">Louvre</th>
                                <th style="min-width: 55px;">Tilt</th>
                                <th style="min-width: 65px;">Layout</th>
                                <th style="min-width: 55px;">Panels</th>
                                <th style="min-width: 55px;">Stile</th>
                                <th style="min-width: 60px;">Frame</th>
                                <th style="min-width: 50px;">Left</th>
                                <th style="min-width: 45px;">Top</th>
                                <th style="min-width: 50px;">Right</th>
                                <th style="min-width: 55px;">Bottom</th>
                                <th style="min-width: 50px;">Mount</th>
                                <th style="min-width: 65px;">Light Blk</th>
                                <th style="min-width: 55px;">Horiz T</th>
                                <th style="min-width: 55px;">Width</th>
                                <th style="min-width: 55px;">Height</th>
                                <th style="min-width: 60px;">Midrail</th>
                                <th style="min-width: 50px;">Split</th>
                                <th style="min-width: 65px;">Block Out</th>
                                <th style="min-width: 60px;">Ring Pull</th>
                                <th style="min-width: 55px;">Handle</th>
                                <th style="min-width: 55px;">Picture</th>
                                <th style="min-width: 80px;">Flyscreen</th>
                                <th style="min-width: 120px;">Special Instr.</th>
                            </tr>
                        </thead>
                        <tbody id="ssMainRows">
                            <tr>
                                <td colspan="28" style="text-align: center; color: var(--text-muted); padding: 20px;">
                                    No measurements recorded — Add rooms in the Survey tab
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Comments & Additional Items Row -->
                <div style="padding: 12px; border-top: 2px solid var(--norman-blue); background: #f5f5f5;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="font-weight: 600; font-size: 12px; color: var(--norman-blue);">Comments /
                                Notes:</label>
                            <div id="ssComments"
                                style="font-size: 12px; background: white; padding: 8px; border-radius: 4px; min-height: 40px; border: 1px solid var(--border);">
                                -</div>
                        </div>
                        <div>
                            <label style="font-weight: 600; font-size: 12px; color: var(--norman-blue);">Additional
                                Items:</label>
                            <div id="ssAdditionalItems"
                                style="font-size: 12px; background: white; padding: 8px; border-radius: 4px; min-height: 40px; border: 1px solid var(--border);">
                                -</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Signature -->
            <div class="card">
                <div class="card-title">Customer Signature</div>
                <div class="sig-box" id="sigBox" onclick="openSigModal('customer')">
                    <span id="sigPlaceholder">Tap to sign</span>
                    <canvas id="sigCanvas"></canvas>
                    <div class="sig-check">✓</div>
                </div>
                <button class="btn btn-outline" onclick="clearProjectSig()" style="font-size: 12px; padding: 8px;">Clear
                    Signature</button>
            </div>

            <!-- Surveyor Signature -->
            <div class="card">
                <div class="card-title">Surveyor Signature</div>
                <div class="sig-box" id="surveyorSigBox" onclick="openSigModal('surveyor')">
                    <span id="surveyorSigPlaceholder">Tap to sign</span>
                    <canvas id="surveyorSigCanvas"></canvas>
                    <div class="sig-check">✓</div>
                </div>
                <button class="btn btn-outline" onclick="clearSurveyorSig()"
                    style="font-size: 12px; padding: 8px;">Clear Signature</button>
            </div>

            <!-- Buttons -->
            <button class="btn btn-outline" onclick="downloadCSV()" style="margin-bottom: 12px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="7 10 12 15 17 10" />
                    <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
                DOWNLOAD CSV
            </button>
            <button class="btn btn-success" onclick="submitOrder()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13" />
                    <path d="M22 2L15 22 11 13 2 9l20-7z" />
                </svg>
                SUBMIT ORDER
            </button>

            <div style="display:flex; gap:10px; margin-top:12px;">
                <button class="btn btn-outline" onclick="pleaseQuote()"
                    style="flex:1; border-color:#ff9800; color:#ff9800;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                    </svg>
                    PLEASE QUOTE
                </button>
                <button class="btn btn-outline" onclick="sendQuote()"
                    style="flex:1; border-color:#2196f3; color:#2196f3;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                        <polyline points="22,6 12,13 2,6" />
                    </svg>
                    SEND QUOTE
                </button>
            </div>
        </div>

        <!-- ==================== INSTALL TAB ==================== -->
        <div id="v-install" class="view">
            <h2>INSTALLATION</h2>

            <!-- Job Selector -->
            <div class="card" style="border-left: 4px solid var(--norman-blue);">
                <div class="card-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="21 8 21 21 3 21 3 8" />
                        <rect x="1" y="3" width="22" height="5" />
                        <line x1="10" y1="12" x2="14" y2="12" />
                    </svg>
                    Select Job
                </div>
                <select id="installJobSelector" onchange="loadArchivedJob(this.value)"
                    style="font-size: 14px; font-weight: 600;">
                    <option value="">— Select an ordered job —</option>
                </select>
            </div>

            <!-- ========== INSTALLATION COMPLETE ========== -->
            <div class="card" style="border-left: 4px solid var(--success);">
                <div class="card-title" style="color: var(--success);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                        <polyline points="22 4 12 14.01 9 11.01" />
                    </svg>
                    Installation Complete
                </div>

                <!-- Checklist -->
                <div style="display: flex; flex-direction: column; gap: 14px; margin-bottom: 16px;">
                    <label class="custom-check">
                        <input type="checkbox" id="installCheck1">
                        <span class="check-box"></span>
                        All products installed
                    </label>
                    <label class="custom-check">
                        <input type="checkbox" id="installCheck2">
                        <span class="check-box"></span>
                        Operation, care &amp; maintenance discussed
                    </label>
                    <label class="custom-check">
                        <input type="checkbox" id="installCheck3">
                        <span class="check-box"></span>
                        Warranty information provided
                    </label>
                    <label class="custom-check">
                        <input type="checkbox" id="installCheck4">
                        <span class="check-box"></span>
                        Site clean and well presented
                    </label>
                    <label class="custom-check">
                        <input type="checkbox" id="installCheck5">
                        <span class="check-box"></span>
                        Invoice received
                    </label>
                </div>

                <!-- Comments -->
                <div class="card-title" style="margin-top: 4px;">Comments</div>
                <textarea id="installCompleteComments" rows="3"
                    placeholder="Any comments about the installation..."></textarea>

                <!-- Client Signature -->
                <div class="card-title" style="margin-top: 12px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 19l7-7 3 3-7 7-3-3z" />
                        <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z" />
                        <path d="M2 2l7.586 7.586" />
                    </svg>
                    Client Signature
                </div>
                <div class="sig-box" id="installerSigBox" onclick="openSigModal('installer')">
                    <span id="installerSigPlaceholder">Tap to sign</span>
                    <canvas id="installerSigCanvas"></canvas>
                    <div class="sig-check">✓</div>
                </div>
                <button class="btn btn-outline" onclick="clearInstallerSig()"
                    style="font-size: 12px; padding: 8px; margin-top: 6px;">Clear Signature</button>

                <!-- Complete Button -->
                <button class="btn btn-success" onclick="completeInstallation()" style="margin-top: 16px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                        <polyline points="22 4 12 14.01 9 11.01" />
                    </svg>
                    Mark Installation Complete
                </button>
            </div>

            <!-- ========== INSTALLATION INCOMPLETE (GREEN REPORT) ========== -->
            <div class="card" style="border-left: 4px solid var(--danger);">
                <div class="card-title" style="color: var(--danger);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="12" y1="8" x2="12" y2="12" />
                        <line x1="12" y1="16" x2="12.01" y2="16" />
                    </svg>
                    Installation Incomplete
                </div>

                <!-- Green Report Form -->
                <div id="greenReport" style="background: #c8e6c9; border-radius: 8px; padding: 16px; font-size: 12px;">
                    <div style="font-weight: 800; font-size: 16px; margin-bottom: 12px; color: #1b5e20;">INSTALLATION
                        REPORT</div>

                    <!-- Row 1: Report No + Contact Info + Dates -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                        <div>
                            <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">Report No.</label>
                            <input type="text" id="irReportNo"
                                style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">Installed Date</label>
                            <input type="date" id="irInstalledDate"
                                style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                        <div>
                            <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">Customer's Name</label>
                            <input type="text" id="irCustomerName"
                                style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">Initially Measured
                                by</label>
                            <input type="text" id="irMeasuredBy"
                                style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                        <div>
                            <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">Address</label>
                            <input type="text" id="irAddress"
                                style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">Initially Fitted
                                by</label>
                            <input type="text" id="irFittedBy"
                                style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                        <div>
                            <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">Tel (Home)</label>
                            <input type="tel" id="irTelHome"
                                style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">Invoice No.</label>
                            <input type="text" id="irInvoiceNo"
                                style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                        <div>
                            <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">Tel (Work)</label>
                            <input type="tel" id="irTelWork"
                                style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">Written by</label>
                            <input type="text" id="irWrittenBy"
                                style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                        <div>
                            <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">Map Ref</label>
                            <input type="text" id="irMapRef"
                                style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">How was the Consultant
                                advised?</label>
                            <input type="text" id="irConsultantAdvised"
                                style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px;">
                        </div>
                    </div>

                    <!-- Fault Section -->
                    <div style="border-top: 2px solid #66bb6a; padding-top: 10px; margin-bottom: 10px;">
                        <label style="font-weight: 700; font-size: 11px; color: #1b5e20;">In the Writer's Opinion — Who
                            is at fault? (Please tick)</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px;">
                            <label class="custom-check" style="font-size: 11px;">
                                <input type="checkbox" id="irFaultFactory">
                                <span class="check-box"></span>
                                Factory
                            </label>
                            <label class="custom-check" style="font-size: 11px;">
                                <input type="checkbox" id="irFaultInstaller">
                                <span class="check-box"></span>
                                Installer
                            </label>
                            <label class="custom-check" style="font-size: 11px;">
                                <input type="checkbox" id="irFaultDespatch">
                                <span class="check-box"></span>
                                Despatch
                            </label>
                            <label class="custom-check" style="font-size: 11px;">
                                <input type="checkbox" id="irFaultConsultant">
                                <span class="check-box"></span>
                                Consultant
                            </label>
                            <label class="custom-check" style="font-size: 11px;">
                                <input type="checkbox" id="irFaultBackCharge">
                                <span class="check-box"></span>
                                Back charge
                            </label>
                        </div>
                    </div>

                    <!-- Product / Return Info -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                        <div>
                            <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">Product</label>
                            <input type="text" id="irProduct"
                                style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">Date to be
                                refitted</label>
                            <input type="date" id="irRefitDate"
                                style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                        <div>
                            <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">Product returned to
                                factory?</label>
                            <select id="irReturnedToFactory"
                                style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px;">
                                <option>No</option>
                                <option>Yes</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">C.O.D. Outstanding
                                $</label>
                            <input type="text" id="irCOD"
                                style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px;">
                        </div>
                    </div>

                    <!-- Nature of Problem -->
                    <div style="margin-bottom: 10px;">
                        <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">Nature of Problem and
                            Recommended Solution</label>
                        <textarea id="irProblem" rows="3"
                            style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px; resize: vertical;"
                            placeholder="Please state nature of problem and your recommended solution..."></textarea>
                    </div>

                    <!-- Measurement Table -->
                    <div style="margin-bottom: 8px;">
                        <label style="font-weight: 700; font-size: 10px; color: #2e7d32;">Date these comments
                            written</label>
                        <input type="date" id="irCommentsDate"
                            style="width: 100%; font-size: 12px; padding: 6px; border: 1px solid #81c784; border-radius: 4px; margin-bottom: 6px;">
                    </div>

                    <div style="overflow-x: auto;">
                        <table
                            style="width: 100%; border-collapse: collapse; font-size: 11px; background: white; border-radius: 4px; overflow: hidden;">
                            <thead>
                                <tr style="background: #66bb6a; color: white;">
                                    <th style="padding: 6px 4px; text-align: left; border: 1px solid #81c784;">#</th>
                                    <th style="padding: 6px 4px; text-align: left; border: 1px solid #81c784;">Made At
                                    </th>
                                    <th style="padding: 6px 4px; text-align: left; border: 1px solid #81c784;">Measured
                                        At</th>
                                    <th style="padding: 6px 4px; text-align: left; border: 1px solid #81c784;">Should Be
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="irTableBody">
                            </tbody>
                        </table>
                        <button class="btn btn-outline" onclick="addIRRow()"
                            style="font-size: 11px; padding: 6px 12px; margin-top: 6px; color: #2e7d32; border-color: #81c784;">+
                            Add Row</button>
                    </div>

                    <div style="margin-top: 10px; font-size: 9px; color: #4caf50;">W111 9/02</div>
                </div>

                <!-- Report Photos -->
                <div style="margin-top: 12px;">
                    <div class="card-title" style="font-size: 13px;">Report Photos</div>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <button class="btn btn-primary" onclick="captureReportPhoto()"
                            style="flex: 1; font-size: 12px; padding: 12px 8px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                <path
                                    d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                                <circle cx="12" cy="13" r="4" />
                            </svg>
                            Take Photo
                        </button>
                        <button class="btn btn-outline" onclick="browseReportPhoto()"
                            style="flex: 1; font-size: 12px; padding: 12px 8px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                            </svg>
                            Browse Files
                        </button>
                    </div>
                    <input type="file" id="reportPhotoCapture" accept="image/*" capture="environment"
                        style="display:none;" onchange="handleReportPhoto(this)">
                    <input type="file" id="reportPhotoBrowse" accept="image/*" style="display:none;"
                        onchange="handleReportPhoto(this)">
                    <div id="reportPhotoThumbs" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                    <p id="reportPhotosEmpty"
                        style="font-size: 12px; color: var(--text-muted); text-align: center; margin: 4px 0 0;">No
                        photos added</p>
                </div>

                <!-- Submit Button -->
                <button class="btn btn-danger" onclick="submitInstallReport()" style="margin-top: 16px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13" />
                        <path d="M22 2L15 22 11 13 2 9l20-7z" />
                    </svg>
                    Submit Report to Head Office
                </button>
            </div>
        </div>

        <!-- ==================== ARCHIVE TAB ==================== -->
        <div id="v-archive" class="view">
            <h2>ARCHIVE</h2>

            <div id="archiveList">
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"
                        style="margin-bottom: 12px; opacity: 0.5;">
                        <polyline points="21 8 21 21 3 21 3 8" />
                        <rect x="1" y="3" width="22" height="5" />
                        <line x1="10" y1="12" x2="14" y2="12" />
                    </svg>
                    <p>No Archived Jobs</p>
                    <p style="font-size: 12px;">Completed jobs will appear here</p>
                </div>
            </div>
        </div>

        <!-- SUB-TABS (Room tabs for Survey, Spec tabs for Specs) - FIXED above nav -->
        <div id="subTabsContainer"
            style="display: none; position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); width: 100%; max-width: 500px; padding: 8px 12px; background: #f8f9fa; border-top: 1px solid var(--border); z-index: 99; overflow-x: auto; -webkit-overflow-scrolling: touch;">
            <!-- Room Sub-Tabs (Survey) -->
            <div id="bottomRoomTabs"
                style="display: none; display: flex; gap: 4px; flex-wrap: nowrap; justify-content: flex-start;"></div>
            <!-- Spec Sub-Tabs (Specs) -->
            <div id="bottomSpecTabs"
                style="display: none; display: flex; gap: 4px; flex-wrap: nowrap; justify-content: center;"></div>
        </div>

        <style>
            .room-tab-btn {
                padding: 8px 12px;
                border: 2px solid var(--border);
                background: white;
                border-radius: 8px;
                font-size: 11px;
                font-weight: 700;
                cursor: pointer;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 2px;
            }

            .room-tab-btn.active {
                border-color: var(--norman-blue);
                background: var(--norman-blue);
                color: white;
            }

            .room-tab-btn.unvisited {
                color: var(--norman-blue);
                border-color: var(--norman-blue);
            }

            .room-tab-btn .room-product {
                font-size: 9px;
                opacity: 0.8;
            }

            .room-tab-btn.active .room-product {
                color: rgba(255, 255, 255, 0.8);
            }
        </style>

        <!-- NAV BAR -->
        <nav class="nav">
            <button class="nav-btn active" onclick="go('project')" id="n-project"><svg viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7" />
                    <rect x="14" y="3" width="7" height="7" />
                    <rect x="14" y="14" width="7" height="7" />
                    <rect x="3" y="14" width="7" height="7" />
                </svg>Project</button>
            <button class="nav-btn" onclick="go('survey')" id="n-survey"><svg viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14 2 14 8 20 8" />
                    <line x1="16" y1="13" x2="8" y2="13" />
                    <line x1="16" y1="17" x2="8" y2="17" />
                </svg>Surveyor</button>
            <button class="nav-btn" onclick="go('specs')" id="n-specs"><svg viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3" />
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4" />
                </svg>Specs</button>
            <button class="nav-btn" onclick="go('review')" id="n-review"><svg viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                    <polyline points="22 4 12 14.01 9 11.01" />
                </svg>Review</button>
            <button class="nav-btn" onclick="go('install')" id="n-install"><svg viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <path
                        d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />
                </svg>Install</button>
            <button class="nav-btn" onclick="go('archive')" id="n-archive"><svg viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <polyline points="21 8 21 21 3 21 3 8" />
                    <rect x="1" y="3" width="22" height="5" />
                    <line x1="10" y1="12" x2="14" y2="12" />
                </svg>Archive</button>
        </nav>
    </div>

    <script>
        // ============ STATE ============
        let state = {
            rooms: [],
            currentRoom: 0,
            archive: JSON.parse(localStorage.getItem('westralArchive') || '[]')
        };

        // ============ APP INIT ============
        function initApp() {
            console.log("App Version: 2.0 (Launch Build)");
            // Auto-populate date
            document.getElementById('jobDate').value = new Date().toLocaleDateString('en-AU');

            // Load saved surveyor name
            const savedName = localStorage.getItem('westralSurveyor');
            if (savedName) document.getElementById('surveyor').value = savedName;

            // Save surveyor name on change
            document.getElementById('surveyor').onchange = function () {
                localStorage.setItem('westralSurveyor', this.value);
            };

            // Load user defaults if any
            loadUserDefaults();

            // Initialize auto-save for Survey fields
            setupAutoSave();

            // Restore active session if any
            restoreActiveSession();
        }

        function persistActiveSession() {
            const activeSession = {
                clientName: document.getElementById('clientName').value,
                clientAddr: document.getElementById('clientAddr').value,
                clientPhone: document.getElementById('clientPhone').value,
                clientEmail: document.getElementById('clientEmail').value,
                consultantEmail: document.getElementById('consultantEmail').value,
                jobRef: document.getElementById('jobRef').value,
                jobComments: document.getElementById('jobComments').value,
                specProduct: document.getElementById('specProduct').value,
                specMount: document.getElementById('specMount').value,
                specMountMethod: document.getElementById('specMountMethod').value,
                specFrame: document.getElementById('specFrame').value,
                specStile: document.getElementById('specStile').value,
                specColor: document.getElementById('specColor').value,
                specHinge: document.getElementById('specHinge').value,
                specTilt: document.getElementById('specTilt').value,
                specBlade: document.getElementById('specBlade').value,
                rooms: state.rooms,
                currentRoom: state.currentRoom,
                // Save signature dataURLs if they exist
                customerSig: document.getElementById('sigBox').classList.contains('has-sig') ? document.getElementById('sigCanvas').toDataURL() : null,
                surveyorSig: document.getElementById('surveyorSigBox').classList.contains('has-sig') ? document.getElementById('surveyorSigCanvas').toDataURL() : null
            };
            localStorage.setItem('westralActiveSession', JSON.stringify(activeSession));
        }

        function restoreActiveSession() {
            const sessionData = localStorage.getItem('westralActiveSession');
            if (!sessionData) return;
            const session = JSON.parse(sessionData);
            if (!session || !session.rooms || session.rooms.length === 0) return;

            if (confirm(`Unfinished job found for ${session.clientName || 'Unknown Client'}.\n\nResume previous work?`)) {
                document.getElementById('clientName').value = session.clientName || '';
                document.getElementById('clientAddr').value = session.clientAddr || '';
                document.getElementById('clientPhone').value = session.clientPhone || '';
                document.getElementById('clientEmail').value = session.clientEmail || '';
                document.getElementById('consultantEmail').value = session.consultantEmail || '';
                document.getElementById('jobRef').value = session.jobRef || '';
                document.getElementById('jobComments').value = session.jobComments || '';
                document.getElementById('specProduct').value = session.specProduct || 'Woodlore';
                document.getElementById('specMount').value = session.specMount || 'Inside';
                document.getElementById('specMountMethod').value = session.specMountMethod || 'Z Frame';
                document.getElementById('specFrame').value = session.specFrame || 'Bullnose Z 38mm';
                document.getElementById('specStile').value = session.specStile || 'Stile 50mm';
                document.getElementById('specColor').value = session.specColor || 'Pure White 001';
                document.getElementById('specHinge').value = session.specHinge || 'White';
                document.getElementById('specTilt').value = session.specTilt || 'Clearview';
                document.getElementById('specBlade').value = session.specBlade || '89mm';

                state.rooms = session.rooms;
                state.currentRoom = session.currentRoom || 0;

                // Sync UI
                updateProductOptions();
                renderRoomTabs();
                loadRoomData(state.currentRoom);

                // Restore Signatures
                if (session.customerSig) {
                    restoreSignature('sigCanvas', 'sigBox', 'sigPlaceholder', session.customerSig);
                }
                if (session.surveyorSig) {
                    restoreSignature('surveyorSigCanvas', 'surveyorSigBox', 'surveyorSigPlaceholder', session.surveyorSig);
                }
            } else {
                localStorage.removeItem('westralActiveSession');
            }
        }

        function restoreSignature(canvasId, boxId, placeholderId, dataUrl) {
            const canvas = document.getElementById(canvasId);
            const box = document.getElementById(boxId);
            const placeholder = document.getElementById(placeholderId);
            const img = new Image();
            img.onload = function () {
                canvas.width = box.offsetWidth;
                canvas.height = box.offsetHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, canvas.width, canvas.height);
                box.classList.add('has-sig');
                if (placeholder) placeholder.classList.add('hidden');
            };
            img.src = dataUrl;
        }

        // ============ NAV ============
        let currentView = 'project';

        function go(view) {
            // Auto-save on leaving any tab
            if (currentView === 'survey') {
                saveCurrentRoomData();
            }
            // Auto-generate review data when leaving any tab (so Review is always fresh)
            if (view === 'review' || currentView !== 'review') {
                try { generateReview(); } catch (e) { }
            }
            currentView = view;

            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('v-' + view).classList.add('active');
            document.getElementById('n-' + view).classList.add('active');

            // Manage sub-tabs visibility
            const subTabsContainer = document.getElementById('subTabsContainer');
            const bottomRoomTabs = document.getElementById('bottomRoomTabs');
            const bottomSpecTabs = document.getElementById('bottomSpecTabs');

            if (view === 'survey') {
                subTabsContainer.style.display = 'block';
                bottomRoomTabs.style.display = 'flex';
                bottomSpecTabs.style.display = 'none';
                syncProjectToSurvey(); // Sync Project page data to Survey rooms
                renderRoomTabs(); // Render room tabs in bottom area
                // Scroll survey view to top
                document.getElementById('v-survey').scrollTop = 0;
                window.scrollTo(0, 0);
            } else if (view === 'specs') {
                subTabsContainer.style.display = 'block';
                bottomRoomTabs.style.display = 'none';
                bottomSpecTabs.style.display = 'flex';
                renderSpecTabs(); // Render spec tabs in bottom area
            } else {
                subTabsContainer.style.display = 'none';
                bottomRoomTabs.style.display = 'none';
                bottomSpecTabs.style.display = 'none';
            }

            // Populate install job selector when entering install tab
            if (view === 'install') {
                populateInstallJobSelector();
            }
            // Refresh archive when entering archive tab
            if (view === 'archive') {
                renderArchive();
            }
        }

        function renderSpecTabs() {
            const container = document.getElementById('bottomSpecTabs');
            const specs = ['wl', 'wlp', 'wp', 'brite', 'nmdy', 'xref', 'tech'];
            const labels = { wl: 'WL', wlp: 'WL+', wp: 'WL+WP', brite: 'BRITE', nmdy: 'NMDY', xref: 'X REF', tech: 'TECH' };

            container.innerHTML = specs.map(s => {
                const isActive = document.getElementById('spec-' + s)?.classList.contains('active');
                return `<button onclick="showSpec('${s}')" class="spec-tab ${isActive ? 'active' : ''}">${labels[s]}</button>`;
            }).join('');
        }

        // ============ SCAN FUNCTIONS (Gemini AI v3.0) ============
        const GEMINI_API_KEY = 'AIzaSyBtd2Hr4pOSJSUV6OlzE6TrDW5A17V4yTU';

        function triggerScan() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) {
                document.getElementById('scanInput').click();
            } else {
                // Desktop: use file picker or demo data
                if (confirm('Desktop detected.\n\nChoose photo file? (Cancel = demo data)')) {
                    document.getElementById('scanInput').click();
                } else {
                    simulateScan();
                }
            }
        }

        // --- Scan Overlay UI ---
        function showScanOverlay(msg) {
            let ov = document.getElementById('scanOverlay');
            if (!ov) {
                ov = document.createElement('div');
                ov.id = 'scanOverlay';
                ov.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.88);z-index:9000;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;font-size:17px;text-align:center;padding:40px;';
                ov.innerHTML = '<div style="width:50px;height:50px;border:3px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:20px;"></div><div id="scanOverlayMsg" style="white-space:pre-line;"></div>';
                document.body.appendChild(ov);
            }
            ov.style.display = 'flex';
            document.getElementById('scanOverlayMsg').textContent = msg;
        }
        function updateScanOverlay(msg) {
            const el = document.getElementById('scanOverlayMsg');
            if (el) el.textContent = msg;
        }
        function hideScanOverlay() {
            const el = document.getElementById('scanOverlay');
            if (el) el.style.display = 'none';
        }

        // --- Handle photo from camera (Gemini AI) ---
        async function handleScanFile(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            input.value = ''; // Clear for next scan

            const apiKey = GEMINI_API_KEY;

            showScanOverlay('Preparing image...');

            try {
                // Convert image to base64
                const base64 = await fileToBase64(file);
                updateScanOverlay('Sending to Gemini AI...\nThis takes 5-10 seconds.');

                // Call Gemini API
                const extractedData = await callGeminiVision(apiKey, base64, file.type || 'image/jpeg');
                hideScanOverlay();

                console.log('Gemini extracted:', extractedData);

                if (!extractedData || Object.keys(extractedData).length === 0) {
                    if (confirm('Could not extract data from this image.\nTry a clearer photo.\n\nLoad demo data instead?')) {
                        simulateScan();
                    }
                    return;
                }

                // Apply extracted data directly to form fields (all as blue/scanned)
                applyScanData(extractedData);

            } catch (err) {
                hideScanOverlay();
                console.error('Gemini scan error:', err);

                if (err.message && err.message.includes('API key')) {
                    alert('API key error: ' + err.message);
                    return;
                }

                if (confirm('Scan failed: ' + (err.message || 'Unknown error') + '\n\nLoad demo data instead?')) {
                    simulateScan();
                }
            }
        }

        // Apply scanned data directly to all relevant fields as blue text
        function applyScanData(data) {
            let summary = [];

            // --- PROJECT PAGE: Customer Details ---
            if (data.clientName) { fillScanned('clientName', data.clientName); summary.push('✓ Customer: ' + data.clientName); }
            if (data.address) { fillScanned('clientAddr', data.address); summary.push('✓ Address'); }
            if (data.contactNumber) { fillScanned('clientPhone', data.contactNumber); summary.push('✓ Phone'); }
            if (data.email) { fillScanned('clientEmail', data.email); }
            if (data.id) { fillScanned('jobRef', data.id); summary.push('✓ Quote Ref: ' + data.id); }
            if (data.comments) { fillScanned('jobComments', data.comments); }

            // --- PROJECT PAGE: Consultant Email ---
            if (data.consultantEmail) {
                fillScanned('consultantEmail', data.consultantEmail);
                summary.push('✓ Consultant: ' + data.consultantEmail);
            }

            // --- PROJECT PAGE: Product Choices (set as scanned/blue) ---
            if (data.measurements && data.measurements.length > 0) {
                const first = data.measurements[0]; // Use first room's specs as project defaults

                if (first.productLine) { fillScannedSelect('specProduct', first.productLine); }
                if (first.blade) { fillScannedSelect('specBlade', first.blade); }
                if (first.color) { fillScannedSelect('specColor', first.color); }
                if (first.mountingMethod) { fillScannedSelect('specMountMethod', first.mountingMethod); }
                if (first.hingeColour) { fillScannedSelect('specHinge', first.hingeColour); }
            }

            // --- SURVEY PAGE: Create room tabs (qty > 1 = multiple tabs) ---
            if (Array.isArray(data.measurements) && data.measurements.length > 0) {
                const rooms = [];
                data.measurements.forEach(m => {
                    const qty = parseInt(m.qty) || 1;
                    const roomName = m.room || 'Room';
                    const width = parseInt(m.width) || 0;
                    const drop = parseInt(m.height) || 0;
                    const product = m.productLine || document.getElementById('specProduct').value || 'Woodlore';

                    if (qty > 1) {
                        // Create multiple tabs: "Dining 1", "Dining 2", etc.
                        for (let i = 1; i <= qty; i++) {
                            rooms.push({
                                name: roomName + ' ' + i,
                                width: width,
                                drop: drop,
                                product: product,
                                scannedData: m
                            });
                        }
                    } else {
                        rooms.push({
                            name: roomName,
                            width: width,
                            drop: drop,
                            product: product,
                            scannedData: m
                        });
                    }
                });

                const defaultProduct = document.getElementById('specProduct').value || 'Woodlore';
                state.rooms = rooms.map(r => ({
                    name: r.name,
                    posts: [], dividers: [], packers: [], drawings: [],
                    frame: { top: 'YES', left: 'YES', right: 'YES', bottom: 'YES' },
                    specs: { product: r.product || defaultProduct },
                    product: r.product || defaultProduct,
                    scannedOverrides: {},
                    scannedWidth: r.width,
                    scannedDrop: r.drop
                }));
                state.currentRoom = 0;
                renderRoomTabs();
                loadRoomData(0);
                summary.push('✓ ' + rooms.length + ' room tab(s) created');
            }

            // alert('Scan Applied! ✓\n\n' + summary.join('\n') +
            //     '\n\nTap any BLUE field to verify it (turns black).');
        }

        // Fill a select element with scanned value (fuzzy match)
        function fillScannedSelect(id, value) {
            const el = document.getElementById(id);
            if (!el) return;
            const val = value.toString().toLowerCase().trim();

            // Try exact match first
            for (const opt of el.options) {
                if (opt.value.toLowerCase() === val || opt.text.toLowerCase() === val) {
                    el.value = opt.value;
                    el.classList.add('scanned');
                    return;
                }
            }
            // Try partial match
            for (const opt of el.options) {
                if (opt.value.toLowerCase().includes(val) || val.includes(opt.value.toLowerCase()) ||
                    opt.text.toLowerCase().includes(val) || val.includes(opt.text.toLowerCase())) {
                    el.value = opt.value;
                    el.classList.add('scanned');
                    return;
                }
            }
            // No match - still mark as scanned with closest guess
            el.classList.add('scanned');
        }

        // Convert file to base64 string (without data URL prefix)
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const result = reader.result;
                    // Strip the data URL prefix to get pure base64
                    const base64 = result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = () => reject(new Error('Could not read file'));
                reader.readAsDataURL(file);
            });
        }

        // Call Google Gemini 2.5 Flash Vision API
        async function callGeminiVision(apiKey, base64Image, mimeType) {
            const url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + apiKey;

            const requestBody = {
                contents: [{
                    parts: [
                        {
                            inlineData: {
                                mimeType: mimeType,
                                data: base64Image
                            }
                        },
                        {
                            text: `Analyze this image of a Westral window furnishing order form.

Extract ALL data into structured JSON. This form has two possible page types:

**PAGE 1 - Installation Copy** (has "Installation" header):
- Client Name, Address, Contact Numbers, Email
- Quote/Reference number (top right)
- Instructions / "FIT AT" / "Client to Remove Fittings" → as "comments"
- Consultant name, phone, and email at the bottom (format: Name / Phone / email@westral.com.au)
- Line item table with: Line No, Location/Room, Qty, Width, Drop, Product, Specifications

**PAGE 2 - Check Measure Copy** (has "Installer to Check Measure" header):
- Customer name, Consultant info, Instructions
- Detailed table with: Line No, Qty, Location, Width, Drop, In/Out, Panel Qty, Blade Size, Material, Colour, Divider Height, Layout Code, Mounting Method, Hinge Colour, Frame details

**IMPORTANT extraction rules:**
- The consultant email will be in format "name@westral.com.au" or "firstname.lastname@westral.com.au"
- For Qty: if a line item has qty=2, report that qty so the app can create 2 separate tabs
- Width and Height/Drop should be clean numbers in mm
- For Product/Material: look for "Woodlore", "Woodlore Plus", "Brightwood", "Normandy"
- For Blade: extract as "47mm", "63mm", "76mm", "89mm", or "114mm"
- For Colour: extract full colour name like "Silk White", "Pure White"
- For Mounting Method: "Hinged", "Track", or "Bi-fold"
- For Hinge Colour: "Silk White", "Pure White", "Stainless Steel", etc.
- If a field is blank or illegible, return empty string ""

Return valid JSON matching this exact structure:
{
  "id": "string",
  "clientName": "string",
  "address": "string",
  "contactNumber": "string",
  "email": "string",
  "consultantName": "string",
  "consultantPhone": "string",
  "consultantEmail": "string",
  "comments": "string",
  "measurements": [
    {
      "lineNo": "string",
      "room": "string",
      "qty": "string",
      "width": "string",
      "height": "string",
      "panelQty": "string",
      "productLine": "string",
      "blade": "string",
      "color": "string",
      "mountingMethod": "string",
      "hingeColour": "string",
      "mount": "string",
      "frame": "string"
    }
  ]
}

Return ONLY the JSON, no markdown fences or extra text.`
                        }
                    ]
                }],
                generationConfig: {
                    responseMimeType: 'application/json',
                    temperature: 0.1
                }
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errBody = await response.text();
                console.error('Gemini API error:', response.status, errBody);
                if (response.status === 400 || response.status === 403) {
                    throw new Error('API key invalid or expired. Get a new one at aistudio.google.com/apikey');
                }
                throw new Error('Gemini API error (HTTP ' + response.status + ')');
            }

            const data = await response.json();

            // Extract text from Gemini response
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) {
                throw new Error('Empty response from Gemini');
            }

            // Parse JSON - Gemini should return clean JSON with responseMimeType set
            try {
                return JSON.parse(text);
            } catch (parseErr) {
                // Try to extract JSON from markdown fences if present
                const jsonMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[1]);
                }
                console.error('Could not parse Gemini response:', text);
                throw new Error('Could not parse AI response');
            }
        }

        // --- Demo/fallback simulation ---
        function simulateScan() {
            fillScanned('clientName', 'Mrs. Jane Smith');
            fillScanned('clientAddr', '24 Ocean View Drive, Cottesloe WA 6011');
            fillScanned('clientPhone', '0412 345 678');
            fillScanned('clientEmail', 'jane.smith@email.com');
            fillScanned('consultantEmail', 'demo.consultant@westral.com.au');

            const defaultProduct = document.getElementById('specProduct').value || 'Woodlore';
            const makeRoom = (name, product) => ({
                name: name,
                posts: [], dividers: [], packers: [], drawings: [],
                frame: { top: 'YES', left: 'YES', right: 'YES', bottom: 'YES' },
                specs: { product: product || defaultProduct },
                product: product || defaultProduct,
                scannedOverrides: {}
            });

            state.rooms = [
                makeRoom('Master Bed', defaultProduct),
                makeRoom('Bed 2', defaultProduct),
                makeRoom('Living', defaultProduct),
                makeRoom('Bathroom', 'Woodlore Plus')
            ];
            state.currentRoom = 0;
            renderRoomTabs();
            loadRoomData(0);

            alert('Demo Scan Loaded!\n\n✓ Sample customer details\n✓ 4 demo rooms created\n\nTap any BLUE field to verify it (turns black).');
        }

        function fillScanned(id, val) {
            const el = document.getElementById(id);
            if (!el) return;
            el.value = val;
            el.classList.add('scanned');
        }

        // ============ VERIFY (Blue → Black) ============
        // For scanned fields: first click removes blue and blocks interaction, second click works normally
        function verify(el) {
            let isRoomSpec = el.id.startsWith('room');

            if (el.classList.contains('scanned')) {
                // Block interaction on first click, just remove blue
                el.classList.remove('scanned');
                el.blur(); // Prevent keyboard/dropdown from opening

                // If it's a select or input, we want to ensure any default behavior is blocked
                if (window.event) {
                    window.event.preventDefault();
                    window.event.stopPropagation();
                }

                // Propagate verification to state if it's a room spec
                if (isRoomSpec && state.rooms[state.currentRoom]?.scannedOverrides) {
                    const key = el.id.replace('room', '');
                    const specKey = key.charAt(0).toLowerCase() + key.slice(1);
                    delete state.rooms[state.currentRoom].scannedOverrides[specKey];
                }

                // Trigger auto-save so Review tab updates immediately
                saveCurrentRoomData();
                return false;
            }

            // Trigger auto-save just in case
            saveCurrentRoomData();
        }

        // ============ USER DEFAULTS ============
        function loadUserDefaults() {
            const defaults = JSON.parse(localStorage.getItem('westralDefaults') || '{}');
            if (defaults.frame) document.getElementById('specFrame').value = defaults.frame;
            if (defaults.stile) document.getElementById('specStile').value = defaults.stile;
            // etc.
        }

        function saveUserDefaults() {
            const defaults = {
                frame: document.getElementById('specFrame').value,
                stile: document.getElementById('specStile').value,
                mount: document.getElementById('specMount').value,
                mountMethod: document.getElementById('specMountMethod').value,
                color: document.getElementById('specColor').value,
                hinge: document.getElementById('specHinge').value,
                tilt: document.getElementById('specTilt').value,
                blade: document.getElementById('specBlade').value
            };
            localStorage.setItem('westralDefaults', JSON.stringify(defaults));
            alert('Defaults saved!');
        }

        // ============ PRODUCT-SPECIFIC OPTIONS ============
        // Product specifications data from 2024 Norman specification sheets
        const productOptionsData = {
            'Woodlore': {
                colors: [
                    '001 Pure White', '002 Extra White', '003 Silk White', '006 Pearl', '032 Sea Mist', '063 Decorator\'s White'
                ],
                hinges: [
                    { value: 'Pure White', label: 'Pure White' },
                    { value: 'Silk White', label: 'Silk White' },
                    { value: 'Pearl', label: 'Pearl' },
                    { value: 'Bisque', label: 'Bisque' },
                    { value: 'Crisp Linen', label: 'Crisp Linen' },
                    { value: 'String', label: 'String' },
                    { value: 'Sea Mist', label: 'Sea Mist' },
                    { value: 'Stone Gray', label: 'Stone Gray' },
                    { value: 'Brown Gray', label: 'Brown Gray' },
                    { value: 'Bright Brass', label: 'Bright Brass' },
                    { value: 'Antique Brass', label: 'Antique Brass' },
                    { value: 'Black', label: 'Black' },
                    { value: 'Stainless Steel', label: 'Stainless Steel' },
                    { value: 'Nickel Plated', label: 'Nickel Plated' },
                    { value: 'Brushed Nickel', label: 'Brushed Nickel' }
                ],
                frames: [
                    'Vintage Hang Strip', 'Beaded L', 'Vintage L', 'Deep Plain L',
                    'Deep Bullnose Z', 'Crown Z', 'Bel Air Z', 'Plain L', 'Bullnose Z', 'Serrate Z',
                    'Beaded Z', 'Tilt Out Z', 'Ridge Deco', 'Camber Deco', 'Mission Deco',
                    'Classic Deco', 'Designer Sill Cap', 'Chamfer T-posts', 'T-post with Insert',
                    'Deco Sill frame', 'Mission Sill Frame', 'Mission Sill Cap', '50mm/40mm Sill Plate'
                ],
                blades: ['47mm', '63mm', '76mm', '89mm', '114mm']
            },
            'Woodlore Plus': {
                colors: [
                    '001 Pure White', '002 Extra White', '003 Silk White', '004 Bright White', '006 Pearl',
                    '007 Ivory Lace', '009 Creamy', '012 Crisp Linen', '019 String', '032 Sea Mist',
                    '042 Hall Gray', '063 Decorator\'s White', '066 Winchester White 2010', '075 Storm Gray',
                    '076 Aura White', '080 Taupe Gray', '090 Simply White', '602 Dove'
                ],
                hinges: [
                    { value: 'Pure White', label: 'Pure White' },
                    { value: 'Silk White', label: 'Silk White' },
                    { value: 'Pearl', label: 'Pearl' },
                    { value: 'Bisque', label: 'Bisque' },
                    { value: 'Crisp Linen', label: 'Crisp Linen' },
                    { value: 'String', label: 'String' },
                    { value: 'Sea Mist', label: 'Sea Mist' },
                    { value: 'Stone Gray', label: 'Stone Gray' },
                    { value: 'Brown Gray', label: 'Brown Gray' },
                    { value: 'Taupe Gray', label: 'Taupe Gray' },
                    { value: 'Bright Brass', label: 'Bright Brass' },
                    { value: 'Antique Brass', label: 'Antique Brass' },
                    { value: 'Black', label: 'Black' },
                    { value: 'Stainless Steel', label: 'Stainless Steel' },
                    { value: 'Nickel Plated', label: 'Nickel Plated' },
                    { value: 'Brushed Nickel', label: 'Brushed Nickel' }
                ],
                frames: [
                    'Vintage Hang Strip', 'Vintage L', 'Beaded L', 'Deep Plain L',
                    'Deep Bullnose Z', 'Crown Z', 'Bel Air Z', 'Plain L', 'Bullnose Z', 'Serrate Z',
                    'Beaded Z', 'Tilt Out Z', 'Ridge Deco', 'Camber Deco', 'Mission Deco',
                    'Classic Deco', 'Designer Sill Cap', 'Deco Sill frame', 'Chamfer T-posts',
                    'T-post with Insert', 'Mission Sill Frame', 'Mission Sill Cap', '50mm/40mm Sill Plate'
                ],
                blades: ['47mm', '63mm', '76mm', '89mm', '114mm']
            },
            'Waterproof': {
                colors: [
                    '001 Pure White', '002 Extra White', '003 Silk White', '004 Bright White', '006 Pearl',
                    '007 Ivory Lace', '009 Creamy', '012 Crisp Linen', '019 String', '032 Sea Mist',
                    '042 Hall Gray', '063 Decorator\'s White', '066 Winchester White', '075 Storm Gray',
                    '076 Aura White', '080 Taupe Gray', '090 Simply White', '602 Dove'
                ],
                hinges: [
                    { value: 'Stainless Steel', label: 'Stainless Steel' },
                    { value: 'Painted (No Warranty)', label: 'Painted (No Warranty)' }
                ],
                frames: [
                    'Vintage Hang Strip', 'Vintage L', 'Beaded L', 'Deep Plain L',
                    'Deep Bullnose Z', 'Crown Z', 'Bel Air Z', 'Plain L', 'Bullnose Z', 'Serrate Z',
                    'Beaded Z', 'Tilt Out Z', 'Ridge Deco', 'Camber Deco', 'Mission Deco',
                    'Classic Deco', 'Designer Sill Cap', 'Deco Sill frame', 'Chamfer T-posts',
                    'T-post with Insert', 'Mission Sill Frame', 'Mission Sill Cap', '50mm/40mm Sill Plate'
                ],
                blades: ['47mm', '63mm', '76mm', '89mm', '114mm']
            },
            'Brightwood': {
                colors: [
                    '001 Pure White', '002 Extra White', '003 Silk White', '004 Bright White', '006 Pearl',
                    '007 Ivory Lace', '009 Creamy', '012 Crisp Linen', '019 String', '032 Sea Mist',
                    '042 Hall Gray', '063 Decorator\'s White', '066 Winchester White 2010', '075 Storm Gray',
                    '076 Aura White', '080 Taupe Gray', '090 Simply White', '602 Dove'
                ],
                hinges: [
                    { value: 'Pure White', label: 'Pure White' },
                    { value: 'Silk White', label: 'Silk White' },
                    { value: 'Pearl', label: 'Pearl' },
                    { value: 'Bisque', label: 'Bisque' },
                    { value: 'Crisp Linen', label: 'Crisp Linen' },
                    { value: 'String', label: 'String' },
                    { value: 'Sea Mist', label: 'Sea Mist' },
                    { value: 'Stone Gray', label: 'Stone Gray' },
                    { value: 'Brown Gray', label: 'Brown Gray' },
                    { value: 'Taupe Gray', label: 'Taupe Gray' },
                    { value: 'Bright Brass', label: 'Bright Brass' },
                    { value: 'Antique Brass', label: 'Antique Brass' },
                    { value: 'Black', label: 'Black' },
                    { value: 'Stainless Steel', label: 'Stainless Steel' },
                    { value: 'Nickel Plated', label: 'Nickel Plated' },
                    { value: 'Brushed Nickel', label: 'Brushed Nickel' }
                ],
                frames: [
                    'Beaded L', 'Vintage Hang Strip', 'Vintage L', 'Deep Plain L',
                    'Deep Bullnose Z', 'Crown Z', 'Bel Air Z', 'Plain L', 'Bullnose Z', 'Serrate Z',
                    'Beaded Z', 'Tilt Out Z', 'Ridge Deco', 'Camber Deco', 'Mission Deco',
                    'Classic Deco', 'Designer Sill Cap', 'Deco Sill frame', 'Chamfer T-posts',
                    'T-post with Insert', 'Mission Sill Frame', 'Mission Sill Cap', '50mm/40mm Sill Plate'
                ],
                blades: ['47mm', '63mm', '76mm', '89mm', '114mm']
            },
            'Normandy': {
                colors: [
                    // Standard Painted Colors
                    '001 Pure White', '002 Extra White', '003 Silk White', '004 Bright White', '006 Pearl',
                    '007 Ivory Lace', '009 Creamy', '012 Crisp Linen', '017 Gray Black*', '019 String',
                    '030 Moondust', '032 Sea Mist', '042 Hall Gray', '049 Stone Gray', '053 Clay',
                    '063 Decorator\'s White', '066 Winchester White', '075 Storm Gray', '076 Aura White',
                    '080 Taupe Gray', '090 Simply White', '836 Classic Black*', '601 Chiffon', '602 Dove',
                    // Stain Colours
                    '110 Limed White', '200 Natural', '202 Golden Oak', '212 Dark Teak', '221 Black Walnut',
                    '227 Red Oak', '229 Rich Walnut', '230 Old Teak', '237 Wenge', '242 Auburn', '246 Matte Black*',
                    '248 Pretzel', '250 Sumatra', '252 Toffee', '254 Driftwood', '255 Silver Gray', '256 Mist', '862 French Oak',
                    // LUXE Colours
                    '1003 White Matte LUXE', '1109 Silk Gray LUXE', '1203 Black LUXE', '1301 Cherry LUXE', '1501 Oak LUXE', '1502 Teak LUXE',
                    // Custom Option
                    '+ Custom Color'
                ],
                hinges: [
                    { value: 'Pure White', label: 'Pure White' },
                    { value: 'Silk White', label: 'Silk White' },
                    { value: 'Bright White', label: 'Bright White' },
                    { value: 'Pearl', label: 'Pearl' },
                    { value: 'Stainless Steel', label: 'Stainless Steel' },
                    { value: 'Bright Brass', label: 'Bright Brass' },
                    { value: 'Antique Brass', label: 'Antique Brass' },
                    { value: 'Black', label: 'Black' },
                    { value: 'Satin Nickel', label: 'Satin Nickel' }
                ],
                frames: [
                    'Vintage Hang Strip', 'Vintage L', 'Beaded L', 'Deep Plain L',
                    'Deep Bullnose Z', 'Crown Z', 'Bel Air Z', 'Plain L', 'Bullnose Z', 'Serrate Z',
                    'Beaded Z', 'Tilt Out Z', 'Ridge Deco', 'Camber Deco', 'Mission Deco',
                    'Classic Deco', 'Designer Sill Cap', 'Deco Sill frame', 'Chamfer T-posts',
                    'T-post with Insert', 'Mission Sill Frame', 'Mission Sill Cap', '50mm/40mm Sill Plate'
                ],
                blades: ['47mm', '63mm', '76mm', '89mm', '114mm']
            }
        };

        function updateProductOptions() {
            const product = document.getElementById('specProduct').value;
            const colorSelect = document.getElementById('specColor');
            const hingeSelect = document.getElementById('specHinge');
            const bladeSelect = document.getElementById('specBlade');
            const frameSelect = document.getElementById('specFrame');

            const opts = productOptionsData[product] || productOptionsData['Woodlore'];

            // Update Color dropdown
            const prevColor = colorSelect.value;
            colorSelect.innerHTML = opts.colors.map(c => `<option value="${c}">${c}</option>`).join('');
            if (opts.colors.includes(prevColor)) {
                colorSelect.value = prevColor;
            }

            // Update Hinge dropdown
            const prevHinge = hingeSelect.value;
            hingeSelect.innerHTML = opts.hinges.map(h => `<option value="${h.value}">${h.label}</option>`).join('');
            if (opts.hinges.some(h => h.value === prevHinge)) {
                hingeSelect.value = prevHinge;
            }

            // Update Frame dropdown
            if (opts.frames) {
                const prevFrame = frameSelect.value;
                frameSelect.innerHTML = opts.frames.map(f => `<option value="${f}">${f}</option>`).join('');
                if (opts.frames.includes(prevFrame)) {
                    frameSelect.value = prevFrame;
                }
            }

            // Update Blade dropdown
            const prevBlade = bladeSelect.value;
            bladeSelect.innerHTML = opts.blades.map(b => `<option value="${b}">${b}</option>`).join('');
            if (opts.blades.includes(prevBlade)) {
                bladeSelect.value = prevBlade;
            }

            // Also update max width based on new product/blade combination
            updateMaxWidth();
        }

        // ============ SIGNATURE ============
        let sigCtx, sigDrawing = false;
        let modalSigCtx, modalSigDrawing = false;
        let currentSigTarget = 'customer'; // 'customer' or 'surveyor'
        let lastX = 0, lastY = 0;

        function openSigModal(target) {
            currentSigTarget = target;
            const modal = document.getElementById('sigModal');
            const canvas = document.getElementById('sigModalCanvas');
            const wrap = document.getElementById('sigModalWrap');

            modal.classList.add('active');
            const titles = { customer: 'Customer Signature', surveyor: 'Surveyor Signature', installer: 'Client Signature' };
            document.getElementById('sigModalTitle').textContent = titles[target] || 'Signature';
            document.getElementById('sigModalHint').style.display = 'block';

            // Set canvas size after modal is visible
            setTimeout(() => {
                canvas.width = wrap.offsetWidth;
                canvas.height = wrap.offsetHeight;
                modalSigCtx = canvas.getContext('2d');
                modalSigCtx.lineWidth = 3;
                modalSigCtx.lineCap = 'round';
                modalSigCtx.lineJoin = 'round';
                modalSigCtx.strokeStyle = '#000';
                setupModalSignatureEvents(canvas);
            }, 50);
        }

        function setupModalSignatureEvents(canvas) {
            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                if (e.touches && e.touches.length > 0) {
                    return {
                        x: (e.touches[0].clientX - rect.left) * scaleX,
                        y: (e.touches[0].clientY - rect.top) * scaleY
                    };
                }
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY
                };
            };

            canvas.onmousedown = canvas.ontouchstart = function (e) {
                e.preventDefault();
                modalSigDrawing = true;
                const pos = getPos(e);
                lastX = pos.x;
                lastY = pos.y;
                modalSigCtx.beginPath();
                modalSigCtx.moveTo(lastX, lastY);
                document.getElementById('sigModalHint').style.display = 'none';
            };

            canvas.onmouseup = canvas.ontouchend = canvas.onmouseleave = canvas.ontouchcancel = function () {
                modalSigDrawing = false;
            };

            canvas.onmousemove = canvas.ontouchmove = function (e) {
                if (!modalSigDrawing) return;
                e.preventDefault();
                const pos = getPos(e);
                modalSigCtx.beginPath();
                modalSigCtx.moveTo(lastX, lastY);
                modalSigCtx.lineTo(pos.x, pos.y);
                modalSigCtx.stroke();
                lastX = pos.x;
                lastY = pos.y;
            };
        }

        function clearModalSig() {
            const canvas = document.getElementById('sigModalCanvas');
            if (modalSigCtx) modalSigCtx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('sigModalHint').style.display = 'block';
        }

        function saveSigFromModal() {
            const modalCanvas = document.getElementById('sigModalCanvas');
            const canvasMap = { customer: 'sigCanvas', surveyor: 'surveyorSigCanvas', installer: 'installerSigCanvas' };
            const boxMap = { customer: 'sigBox', surveyor: 'surveyorSigBox', installer: 'installerSigBox' };
            const placeholderMap = { customer: 'sigPlaceholder', surveyor: 'surveyorSigPlaceholder', installer: 'installerSigPlaceholder' };

            const targetCanvas = document.getElementById(canvasMap[currentSigTarget]);
            const targetBox = document.getElementById(boxMap[currentSigTarget]);
            const placeholder = document.getElementById(placeholderMap[currentSigTarget]);

            // Resize target canvas
            targetCanvas.width = targetBox.offsetWidth;
            targetCanvas.height = targetBox.offsetHeight;
            const ctx = targetCanvas.getContext('2d');

            // Draw modal canvas content scaled to fit
            ctx.drawImage(modalCanvas, 0, 0, modalCanvas.width, modalCanvas.height, 0, 0, targetCanvas.width, targetCanvas.height);

            targetBox.classList.add('has-sig');
            if (placeholder) placeholder.classList.add('hidden');
            closeSigModal();

            // Persist after signature save
            persistActiveSession();
        }

        function closeSigModal() {
            document.getElementById('sigModal').classList.remove('active');
            clearModalSig();
        }

        function clearProjectSig() {
            const canvas = document.getElementById('sigCanvas');
            const box = document.getElementById('sigBox');
            const ctx = canvas.getContext('2d');
            if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
            box.classList.remove('has-sig');
            document.getElementById('sigPlaceholder').classList.remove('hidden');
        }

        function clearSurveyorSig() {
            const canvas = document.getElementById('surveyorSigCanvas');
            const box = document.getElementById('surveyorSigBox');
            const ctx = canvas.getContext('2d');
            if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
            box.classList.remove('has-sig');
            document.getElementById('surveyorSigPlaceholder').classList.remove('hidden');
        }

        // ============ RESET ============
        function resetJob() {
            if (!confirm('Clear ALL job data? This cannot be undone.')) return;

            ['clientName', 'clientAddr', 'clientPhone', 'clientEmail', 'consultantEmail', 'jobRef', 'jobComments'].forEach(id => {
                const el = document.getElementById(id);
                el.value = '';
                el.classList.remove('scanned');
            });

            ['specProduct', 'specMount', 'specMountMethod', 'specFrame', 'specStile', 'specColor', 'specHinge', 'specTilt', 'specBlade'].forEach(id => {
                document.getElementById(id).classList.remove('scanned');
            });

            state.rooms = [];
            clearProjectSig();
            localStorage.removeItem('westralActiveSession');
            alert('Job data cleared.');
        }

        // ============ SURVEY TAB FUNCTIONS ============
        let roomPosts = [];
        let roomDividers = [];
        let roomPackers = [];
        let roomFrameSides = { top: 'YES', left: 'YES', right: 'YES', bottom: 'YES' };

        // Product specs for validation (max single panel width)
        // Product validation specs with per-louver max panel widths (in mm)
        // From 2024 Norman Specification Sheets
        const productSpecs = {
            'Woodlore': {
                maxWidthByBlade: {
                    '47mm': 600,
                    '63mm': 750,
                    '76mm': 914,
                    '89mm': 914,
                    '114mm': 914
                },
                maxHeight: 2700,
                dividerRequired: 1879
            },
            'Woodlore Plus': {
                maxWidthByBlade: {
                    '47mm': 600,
                    '63mm': 920,
                    '76mm': 920,
                    '89mm': 920,
                    '114mm': 920
                },
                maxHeight: 3000,
                dividerRequired: 1981
            },
            'Waterproof': {
                maxWidthByBlade: {
                    '47mm': 610,
                    '63mm': 800,
                    '76mm': 800,
                    '89mm': 920,
                    '114mm': 920
                },
                maxHeight: 3000,
                dividerRequired: 1828
            },
            'Brightwood': {
                maxWidthByBlade: {
                    '47mm': 762,
                    '63mm': 920,
                    '76mm': 920,
                    '89mm': 1066,
                    '114mm': 1066
                },
                maxHeight: 3000,
                dividerRequired: 1981
            },
            'Normandy': {
                maxWidthByBlade: {
                    '47mm': 762,
                    '63mm': 920,
                    '76mm': 920,
                    '89mm': 1095,
                    '114mm': 1095
                },
                maxHeight: 3000,
                dividerRequired: 1981
            }
        };

        // Sync Project page data to Survey room tabs
        function syncProjectToSurvey() {
            // Get values from Project page (all specs EXCEPT product line)
            const projectSpecs = {
                product: document.getElementById('specProduct')?.value || 'Woodlore',
                mount: document.getElementById('specMount')?.value || 'Recess',
                mountMethod: document.getElementById('specMountMethod')?.value || 'Hinged',
                frame: document.getElementById('specFrame')?.value || 'Small Z Frame',
                stile: document.getElementById('specStile')?.value || 'Beaded Butt',
                color: document.getElementById('specColor')?.value || '001 Pure White',
                hinge: document.getElementById('specHinge')?.value || 'Pure White',
                tilt: document.getElementById('specTilt')?.value || 'EasyTilt',
                blade: document.getElementById('specBlade')?.value || '89mm'
            };

            // Update Survey room spec dropdowns with Project values
            // BUT preserve room's own product line if it was set at tab creation
            const currentRoom = state.rooms[state.currentRoom];
            if (currentRoom && currentRoom.specs?.product) {
                // Room has its own product — use it for the dropdown
                document.getElementById('roomProduct').value = currentRoom.specs.product;
            } else {
                document.getElementById('roomProduct').value = projectSpecs.product;
            }
            document.getElementById('roomMount').value = projectSpecs.mount;
            document.getElementById('roomMountMethod').value = projectSpecs.mountMethod;
            document.getElementById('roomFrame').value = projectSpecs.frame;
            document.getElementById('roomStile').value = projectSpecs.stile;
            document.getElementById('roomColor').value = projectSpecs.color;
            document.getElementById('roomHinge').value = projectSpecs.hinge;
            document.getElementById('roomTilt').value = projectSpecs.tilt;
            document.getElementById('roomBlade').value = projectSpecs.blade;

            // Apply non-product specs to rooms that don't have overrides
            state.rooms.forEach((room, idx) => {
                if (!room.specs) {
                    room.specs = { ...projectSpecs };
                    room.product = projectSpecs.product; // For tab label
                } else {
                    // Sync everything EXCEPT product line (locked at tab creation)
                    const lockedProduct = room.specs.product;
                    Object.assign(room.specs, projectSpecs);
                    if (lockedProduct) {
                        room.specs.product = lockedProduct;
                        room.product = lockedProduct;
                    }
                }
            });
        }

        function renderRoomTabs() {
            // Render to BOTH the old location (for fallback) and new bottom location
            const bottomContainer = document.getElementById('bottomRoomTabs');
            const topContainer = document.getElementById('roomTabs');

            if (!state.rooms.length) {
                const emptyHtml = '<span style="color: var(--text-muted); font-size: 12px;">No rooms yet. Scan order form or add manually.</span><button class="btn btn-outline" onclick="addRoom()" style="width: auto; padding: 8px 16px; margin-left: 8px; font-size: 12px;">+ Add Room</button>';
                if (bottomContainer) bottomContainer.innerHTML = emptyHtml;
                if (topContainer) topContainer.innerHTML = '';
                return;
            }

            let html = '';
            state.rooms.forEach((r, i) => {
                const isActive = i === state.currentRoom;
                const isUnvisited = !r.visited;
                const productLabel = r.specs?.product || r.product || '';
                const shortProduct = productLabel.replace('Woodlore Plus', 'WL+').replace('Woodlore', 'WL').replace('Waterproof', 'WP').replace('Brightwood', 'BW').replace('Normandy', 'NM');

                let btnClass = 'room-tab-btn';
                if (isActive) btnClass += ' active';
                else if (isUnvisited) btnClass += ' unvisited';

                html += `<button onclick="selectRoom(${i})" class="${btnClass}">
                    <span>${i + 1}: ${r.name || 'Room ' + (i + 1)}</span>
                    ${shortProduct ? `<span class="room-product">${shortProduct}</span>` : ''}
                </button>`;
            });
            html += '<button onclick="addRoom()" class="room-tab-btn" style="border-style: dashed;">+</button>';

            // Render in bottom location
            if (bottomContainer) bottomContainer.innerHTML = html;
            // Clear top location (it's now in bottom)
            if (topContainer) topContainer.innerHTML = '';
        }

        function selectRoom(idx) {
            saveCurrentRoomData();
            state.currentRoom = idx;
            // Mark room as visited (no longer blue/unvisited)
            if (state.rooms[idx]) {
                state.rooms[idx].visited = true;
            }
            loadRoomData(idx);
            renderRoomTabs();
            // Scroll survey view to top when switching rooms
            document.getElementById('v-survey').scrollTop = 0;
            window.scrollTo(0, 0);
        }

        function addRoom() {
            saveCurrentRoomData();
            // Lock current product line at tab creation
            const currentProduct = document.getElementById('specProduct')?.value || 'Woodlore';
            state.rooms.push({
                name: '',
                posts: [], dividers: [], packers: [],
                frame: { top: 'YES', left: 'YES', right: 'YES', bottom: 'YES' },
                specs: { product: currentProduct },
                product: currentProduct // For tab label
            });
            state.currentRoom = state.rooms.length - 1;
            loadRoomData(state.currentRoom);
            renderRoomTabs();
        }

        function saveCurrentRoomData() {
            if (state.currentRoom < 0 || state.currentRoom >= state.rooms.length) return;
            const r = state.rooms[state.currentRoom];
            r.name = document.getElementById('roomName').value;
            r.panelQty = document.getElementById('panelQty').value;
            r.layout = document.getElementById('layout').value.toUpperCase();
            r.coverStrip = document.getElementById('coverStrip').checked;
            r.width = document.getElementById('mainWidth').value;
            r.height = document.getElementById('mainHeight').value;
            r.split = document.getElementById('splitValue').value;
            r.comments = document.getElementById('roomComments').value;
            r.posts = [...roomPosts];
            r.dividers = [...roomDividers];
            r.packers = [...roomPackers];
            r.frame = { ...roomFrameSides };
            // Save per-room spec overrides
            r.specs = {
                product: document.getElementById('roomProduct').value,
                mount: document.getElementById('roomMount').value,
                mountMethod: document.getElementById('roomMountMethod').value,
                frame: document.getElementById('roomFrame').value,
                stile: document.getElementById('roomStile').value,
                color: document.getElementById('roomColor').value,
                hinge: document.getElementById('roomHinge').value,
                tilt: document.getElementById('roomTilt').value,
                blade: document.getElementById('roomBlade').value
            };
            r.drawings = [...roomDrawings];

            // Backup entire job to LocalStorage
            persistActiveSession();
        }

        function loadRoomData(idx) {
            const r = state.rooms[idx] || {};
            document.getElementById('roomName').value = r.name || '';
            document.getElementById('panelQty').value = r.panelQty || 2;
            document.getElementById('layout').value = r.layout || '';
            // Default Cover Strip to true if undefined, else use saved boolean
            document.getElementById('coverStrip').checked = (r.coverStrip !== false);
            document.getElementById('mainWidth').value = r.width || '';
            document.getElementById('mainHeight').value = r.height || '';
            document.getElementById('splitValue').value = r.split || '';
            document.getElementById('roomComments').value = r.comments || '';
            roomPosts = r.posts ? [...r.posts] : [];
            roomDividers = r.dividers ? [...r.dividers] : [];
            roomPackers = r.packers ? [...r.packers] : [];
            roomFrameSides = r.frame ? { ...r.frame } : { top: 'YES', left: 'YES', right: 'YES', bottom: 'YES' };
            renderPostsList();
            renderDividersList();
            renderPackersList();
            updateFrameDisplay();
            loadRoomSpecs(r.specs);
            updateMaxWidth();
            roomDrawings = r.drawings ? [...r.drawings] : [];
            renderDrawingThumbs();
        }

        function loadRoomSpecs(specs) {
            const list = ['Product', 'Mount', 'MountMethod', 'Frame', 'Stile', 'Color', 'Hinge', 'Tilt', 'Blade'];
            const currentRoom = state.rooms[state.currentRoom];

            // Helper to set value and class
            const setVal = (key) => {
                const el = document.getElementById('room' + key);
                const specKey = key.charAt(0).toLowerCase() + key.slice(1);
                const projectEl = document.getElementById('spec' + key);

                // Determine Source Value
                let val, isScanned;

                // 1. Check for Room Override
                if (specs && specs[specKey]) {
                    val = specs[specKey];
                    // Check if this override is flagged as scanned (unverified)
                    // If specs[specKey] exists but NOT in scannedOverrides, it implies Manual User Entry -> Black
                    if (currentRoom.scannedOverrides && currentRoom.scannedOverrides[specKey]) {
                        isScanned = true;
                    } else {
                        isScanned = false;
                    }
                } else {
                    // 2. Fallback to Project Default
                    val = projectEl.value;
                    // Inherit Scanned status from Project Page
                    isScanned = projectEl.classList.contains('scanned');
                }

                // Apply
                el.value = val;
                if (isScanned) el.classList.add('scanned');
                else el.classList.remove('scanned');
            };

            // Apply to all
            list.forEach(key => setVal(key));

            // Populate dependent dropdowns (Product -> Color, Hinge, Blade)
            // Note: populating clears the options/values, so we must re-set them
            const product = document.getElementById('roomProduct').value;
            populateRoomProductOptions(product);

            // Re-apply dependent values
            ['Color', 'Hinge', 'Blade', 'Frame'].forEach(key => setVal(key));
        }

        function populateRoomProductOptions(product) {
            // Populate Color, Hinge, Blade, and FRAME dropdowns based on product
            const colorSelect = document.getElementById('roomColor');
            const hingeSelect = document.getElementById('roomHinge');
            const bladeSelect = document.getElementById('roomBlade');
            const frameSelect = document.getElementById('roomFrame');

            const opts = productOptionsData[product] || productOptionsData['Woodlore'];

            // Store current values to preserve if valid (though we re-set them in loadRoomSpecs)
            const prevColor = colorSelect.value;
            const prevHinge = hingeSelect.value;
            const prevBlade = bladeSelect.value;
            const prevFrame = frameSelect ? frameSelect.value : '';

            // Update Color dropdown
            colorSelect.innerHTML = opts.colors.map(c => `<option value="${c}">${c}</option>`).join('');

            // Update Hinge dropdown
            hingeSelect.innerHTML = opts.hinges.map(h => `<option value="${h.value}">${h.label}</option>`).join('');

            // Update Blade dropdown
            bladeSelect.innerHTML = opts.blades.map(b => `<option value="${b}">${b}</option>`).join('');

            // Update Frame dropdown (New Addition)
            if (frameSelect && opts.frames) {
                frameSelect.innerHTML = opts.frames.map(f => `<option value="${f}">${f}</option>`).join('');
                // If previous frame is valid for new product, keep it? 
                // Mostly handled by loadRoomSpecs, but good for interactive changes
                if (opts.frames.includes(prevFrame)) {
                    frameSelect.value = prevFrame;
                }
            }
        }

        function updateRoomSpec(el) {
            // Called when a room spec dropdown is changed
            // 1. Clear validation state for this element
            if (el) {
                el.classList.remove('scanned');
                // Remove from scannedOverrides if present
                const currentRoom = state.rooms[state.currentRoom];
                if (currentRoom.scannedOverrides) {
                    // Extract key from ID (roomProduct -> product)
                    const key = el.id.replace('room', '');
                    const specKey = key.charAt(0).toLowerCase() + key.slice(1);
                    delete currentRoom.scannedOverrides[specKey];
                }
            }

            const product = document.getElementById('roomProduct').value;
            // If product changed, repopulate dependent dropdowns
            if (el && el.id === 'roomProduct') {
                populateRoomProductOptions(product);
                // When product changes, dependent fields might default to 1st option
                // We should probably flag them as "Manual" (Black) unless logic dictates otherwise
                // For now, they become Black because they lose 'scanned' class by virtue of being new values?
                // Actually populateRoomProductOptions resets innerHTML, losing 'value'.
                // The browser selects the first option automatically.
                // We should ensure they occupy a valid state.
            }

            // Update max width based on current product/blade
            updateMaxWidth();

            // Auto-save room data? usually explicitly saved, but we update state on tab switch
        }


        // Posts Management
        function toggleDegrees() {
            const type = document.getElementById('postType').value;
            document.getElementById('postDegrees').style.display = (type === 'B' || type === 'C') ? 'block' : 'none';
        }

        // Cycle through post types on button click
        const postTypes = [
            { value: 'T', label: 'T-Post', color: 'var(--success)' },
            { value: 'B', label: 'Bay Post', color: 'var(--norman-blue)' },
            { value: 'C', label: 'Corner', color: '#ff9800' },
            { value: 'G', label: 'Gap', color: '#9c27b0' }
        ];
        let currentPostTypeIdx = 0;

        function cyclePostType() {
            currentPostTypeIdx = (currentPostTypeIdx + 1) % postTypes.length;
            const pt = postTypes[currentPostTypeIdx];
            document.getElementById('postType').value = pt.value;
            const btn = document.getElementById('postTypeBtn');
            btn.textContent = pt.label;
            btn.style.background = pt.color;
            toggleDegrees();
        }

        function addPost() {
            const type = document.getElementById('postType').value;
            const pos = document.getElementById('postPosition').value;
            const deg = document.getElementById('postDegrees').value;
            if (!pos) return;

            const labels = { T: 'T-Post', B: 'Bay', C: 'Corner', G: 'Gap' };
            const post = { type, pos, deg: deg || null, label: labels[type] };
            roomPosts.push(post);
            renderPostsList();
            document.getElementById('postPosition').value = '';
            document.getElementById('postDegrees').value = '';
        }

        function removePost(idx) {
            roomPosts.splice(idx, 1);
            renderPostsList();
        }

        function renderPostsList() {
            const html = roomPosts.map((p, i) =>
                `<span onclick="removePost(${i})" style="background: #e3f2fd; color: #1565c0; padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer;">${p.label} @ ${p.pos}${p.deg ? '° ' + p.deg : ''} ✕</span>`
            ).join('');
            document.getElementById('postsList').innerHTML = html || '<span style="color: var(--text-muted); font-size: 11px;">No posts added</span>';
        }

        // Dividers Management
        function addDivider() {
            const val = document.getElementById('dividerValue').value;
            if (!val) return;
            const crit = document.getElementById('dividerCritical').checked;
            roomDividers.push({ value: val, critical: crit });
            renderDividersList();
            document.getElementById('dividerValue').value = '';
            document.getElementById('dividerCritical').checked = false;
        }

        function removeDivider(idx) {
            roomDividers.splice(idx, 1);
            renderDividersList();
        }

        function renderDividersList() {
            const html = roomDividers.map((d, i) =>
                `<span onclick="removeDivider(${i})" style="background: ${d.critical ? '#ffebee' : '#f3e5f5'}; color: ${d.critical ? '#c62828' : '#7b1fa2'}; padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; ${d.critical ? 'font-weight: 700;' : ''}">MR${i + 1}: ${d.value}${d.critical ? ' (CRIT)' : ''} ✕</span>`
            ).join('');
            document.getElementById('dividersList').innerHTML = html || '<span style="color: var(--text-muted); font-size: 11px;">No dividers added</span>';
        }

        // Packers Management
        function addPacker() {
            const w = document.getElementById('packerW').value;
            const h = document.getElementById('packerH').value;
            const d = document.getElementById('packerD').value;
            const qty = document.getElementById('packerQty').value || 1;
            if (!w || !h || !d) return;
            roomPackers.push({ w, h, d, qty });
            renderPackersList();
            document.getElementById('packerW').value = '';
            document.getElementById('packerH').value = '';
            document.getElementById('packerD').value = '';
            document.getElementById('packerQty').value = '1';
        }

        function removePacker(idx) {
            roomPackers.splice(idx, 1);
            renderPackersList();
        }

        function renderPackersList() {
            const html = roomPackers.map((p, i) =>
                `<span onclick="removePacker(${i})" style="background: #fff3e0; color: #e65100; padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer;">${p.qty}× ${p.w}×${p.h}×${p.d} ✕</span>`
            ).join('');
            document.getElementById('packersList').innerHTML = html || '<span style="color: var(--text-muted); font-size: 11px;">No packers added</span>';
        }

        // Frame Diagram
        function cycleFrame(side) {
            const states = ['YES', 'CILL', 'NO'];
            const current = roomFrameSides[side];
            const next = states[(states.indexOf(current) + 1) % states.length];
            roomFrameSides[side] = next;
            updateFrameDisplay();
        }

        function updateFrameDisplay() {
            ['top', 'left', 'right', 'bottom'].forEach(side => {
                const el = document.getElementById('frame' + side.charAt(0).toUpperCase() + side.slice(1));
                const val = roomFrameSides[side];
                el.textContent = val;
                el.style.background = val === 'YES' ? 'var(--success)' : val === 'NO' ? 'var(--danger)' : 'var(--warning)';
            });
        }

        // Width/Height Validation
        function updateMaxWidth() {
            // Check for room-level overrides first, fallback to project-level
            const roomProduct = document.getElementById('roomProduct');
            const roomBlade = document.getElementById('roomBlade');

            const product = (roomProduct && roomProduct.value) || document.getElementById('specProduct').value || 'Woodlore';
            const blade = (roomBlade && roomBlade.value) || document.getElementById('specBlade').value || '89mm';
            const panelQty = parseInt(document.getElementById('panelQty').value) || 1;

            const spec = productSpecs[product] || productSpecs['Woodlore'];
            const maxSinglePanel = spec.maxWidthByBlade[blade] || spec.maxWidthByBlade['89mm'] || 914;
            const maxW = maxSinglePanel * panelQty;
            document.getElementById('maxWidthLabel').textContent = 'Max: ' + maxW;
        }

        function validateWidth(el) {
            const roomProduct = document.getElementById('roomProduct');
            const roomBlade = document.getElementById('roomBlade');

            const product = (roomProduct && roomProduct.value) || document.getElementById('specProduct').value || 'Woodlore';
            const blade = (roomBlade && roomBlade.value) || document.getElementById('specBlade').value || '89mm';
            const panelQty = parseInt(document.getElementById('panelQty').value) || 1;

            const spec = productSpecs[product] || productSpecs['Woodlore'];
            const maxSinglePanel = spec.maxWidthByBlade[blade] || spec.maxWidthByBlade['89mm'] || 914;
            const maxW = maxSinglePanel * panelQty;

            if (parseInt(el.value) > maxW) el.classList.add('error');
            else el.classList.remove('error');
        }

        function validateHeight(el) {
            const roomProduct = document.getElementById('roomProduct');
            const product = (roomProduct && roomProduct.value) || document.getElementById('specProduct').value || 'Woodlore';

            const spec = productSpecs[product] || productSpecs['Woodlore'];
            if (parseInt(el.value) > spec.maxHeight) el.classList.add('error');
            else el.classList.remove('error');
        }

        // Photo Capture
        function capturePhoto() {
            // Use the hidden file input (scanInput logic but for photo)
            // We'll reuse the scanInput or create a dedicated one. 
            // Better to use a dedicated one to avoid confusion with scan.
            let input = document.getElementById('roomPhotoInput');
            if (!input) {
                input = document.createElement('input');
                input.id = 'roomPhotoInput';
                input.type = 'file';
                input.accept = 'image/*';
                input.capture = 'environment';
                input.style.display = 'none';
                input.onchange = function (e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = function (ev) {
                        const img = document.getElementById('roomPhoto');
                        img.src = ev.target.result;
                        img.style.display = 'block';
                        document.getElementById('photoPlaceholder').style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                };
                document.body.appendChild(input);
            }
            input.click();
        }

        // Save Room
        // ============ DRAWINGS ============
        let roomDrawings = [];

        function captureDrawing() {
            document.getElementById('drawingCapture').click();
        }
        function browseDrawing() {
            document.getElementById('drawingBrowse').click();
        }
        function handleDrawingFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                roomDrawings.push(e.target.result);
                renderDrawingThumbs();
            };
            reader.readAsDataURL(file);
            input.value = ''; // Reset so same file can be re-selected
        }
        function removeDrawing(idx) {
            roomDrawings.splice(idx, 1);
            renderDrawingThumbs();
        }
        function renderDrawingThumbs() {
            const container = document.getElementById('drawingsThumbs');
            const emptyMsg = document.getElementById('drawingsEmpty');
            if (roomDrawings.length === 0) {
                container.innerHTML = '';
                emptyMsg.style.display = 'block';
                return;
            }
            emptyMsg.style.display = 'none';
            container.innerHTML = roomDrawings.map((src, i) => `
                <div style="position: relative; width: 80px; height: 80px; border-radius: 6px; overflow: hidden; border: 1px solid var(--border);">
                    <img src="${src}" style="width: 100%; height: 100%; object-fit: cover;">
                    <div onclick="removeDrawing(${i})" style="position: absolute; top: 2px; right: 2px; width: 22px; height: 22px; background: rgba(200,30,30,0.85); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; cursor: pointer; line-height: 1;">×</div>
                </div>
            `).join('');
        }

        function saveRoom() {
            saveCurrentRoomData();
            // renderRoomTabs(); // Avoid re-rendering tabs on every keystroke to prevent focus loss
            // alert('Room data saved!'); // Silent save
        }

        function setupAutoSave() {
            // Include both Survey and Project view elements for auto-save
            const autoSaveSelectors = '#v-survey, #v-project';
            const context = document.querySelectorAll(autoSaveSelectors);

            context.forEach(view => {
                // Text inputs and textareas -> save on input
                view.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(el => {
                    el.addEventListener('input', () => {
                        if (view.id === 'v-survey') {
                            saveCurrentRoomData();
                        } else {
                            // On Project page, just persist the session
                            persistActiveSession();
                        }
                    });
                    // Ensure room name updates tabs on blur
                    if (el.id === 'roomName') {
                        el.addEventListener('blur', renderRoomTabs);
                    }
                });

                // Selects and checkboxes -> save on change
                view.querySelectorAll('select, input[type="checkbox"]').forEach(el => {
                    el.addEventListener('change', () => {
                        if (view.id === 'v-survey') {
                            saveCurrentRoomData();
                        } else {
                            // On Project page, update product options (if needed) and persist
                            if (el.id === 'specProduct') updateProductOptions();
                            persistActiveSession();
                        }
                    });
                });
            });

            console.log('Auto-save listeners initialized (Survey + Project)');
        }

        // ============ SPECS TAB FUNCTIONS ============
        function showSpec(id) {
            document.querySelectorAll('.spec-panel').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.spec-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('specPanel-' + id).style.display = 'block';
            document.getElementById('spec-' + id)?.classList.add('active');

            // Also update the bottom spec tabs
            renderSpecTabs();

            // Lazy-load PDF when Tech tab is first opened
            if (id === 'tech' && !window._pdfLoaded) {
                loadBrochurePDF();
            }
        }

        // ============ PDF BROCHURE VIEWER ============
        let _pdfLoaded = false;
        async function loadBrochurePDF() {
            if (_pdfLoaded) return;
            _pdfLoaded = true;

            const loadingEl = document.getElementById('pdfLoading');
            const containerEl = document.getElementById('pdfContainer');
            const errorEl = document.getElementById('pdfError');

            try {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

                const pdf = await pdfjsLib.getDocument('Shutter-Brochure-Large-1.pdf').promise;
                loadingEl.style.display = 'none';
                containerEl.style.display = 'block';

                // Render all pages
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const scale = 2; // High-res for retina/mobile
                    const viewport = page.getViewport({ scale });

                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    canvas.style.cursor = 'zoom-in';
                    const pageNum = i;
                    canvas.addEventListener('click', function () { openBrochurePage(this, pageNum); });
                    containerEl.appendChild(canvas);

                    await page.render({
                        canvasContext: canvas.getContext('2d'),
                        viewport: viewport
                    }).promise;
                }
            } catch (err) {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = 'Could not load brochure. Make sure you are connected to the internet for the first load. (' + err.message + ')';
                _pdfLoaded = false; // Allow retry
                console.error('PDF load error:', err);
            }
        }

        function openBrochurePage(canvas, pageNum) {
            const viewer = document.getElementById('brochureViewer');
            const img = document.getElementById('brochureViewerImg');
            const label = document.getElementById('brochurePageLabel');

            // Convert canvas to image for native zoom
            img.src = canvas.toDataURL('image/jpeg', 0.92);
            label.textContent = 'Page ' + pageNum;
            viewer.style.display = 'flex';

            // Enable pinch-to-zoom by modifying viewport
            document.querySelector('meta[name=viewport]').setAttribute('content',
                'width=device-width, initial-scale=1.0, viewport-fit=cover');
        }

        function closeBrochureViewer() {
            document.getElementById('brochureViewer').style.display = 'none';
            document.getElementById('brochureViewerImg').src = '';

            // Restore zoom lock for app
            document.querySelector('meta[name=viewport]').setAttribute('content',
                'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
        }

        // ============ REVIEW TAB FUNCTIONS ============

        function generateReview() {
            // Populate Compact Client Header
            document.getElementById('ssClientName').textContent = document.getElementById('clientName').value || '-';
            document.getElementById('ssClientAddr').textContent = document.getElementById('clientAddr').value || '-';
            document.getElementById('ssClientEmail').textContent = document.getElementById('clientEmail')?.value || '-';
            document.getElementById('ssClientPhone').textContent = document.getElementById('clientPhone')?.value || '-';
            document.getElementById('ssJobRef').textContent = document.getElementById('jobRef').value || '-';
            document.getElementById('ssSurveyor').textContent = document.getElementById('surveyor')?.value || 'Surveyor';
            document.getElementById('ssJobDate').textContent = document.getElementById('jobDate').value || '-';
            document.getElementById('ssConsultant').textContent = document.getElementById('consultantEmail')?.value || '-';

            // Get job-level specs (repeated per row)
            const product = document.getElementById('specProduct').value || '-';
            const method = document.getElementById('specMountMethod')?.value || '-';
            const colour = document.getElementById('specColor').value || '-';
            const hinge = document.getElementById('specHinge')?.value || '-';
            const louvre = document.getElementById('specBlade').value || '-';
            const tilt = document.getElementById('specTilt').value || '-';
            const stile = document.getElementById('specStile')?.value || '-';
            const frame = document.getElementById('specFrame').value || '-';
            const mount = document.getElementById('specMount').value || '-';

            // Populate Comments and Additional Items
            let additionalItems = [];
            let allPackers = [];
            let coverStripHeights = [];

            // Populate Main 28-column Table
            if (state.rooms.length > 0) {
                const rows = state.rooms.map((r, i) => {
                    // Collect extras for summary
                    const hasCoverStrip = r.coverStrip === true || r.coverStrip === 'Yes';
                    if (hasCoverStrip && r.height) coverStripHeights.push(r.height);
                    if (r.packers) allPackers = allPackers.concat(r.packers);

                    // Build midrail string
                    const midrails = (r.dividers || []).map((d, di) => `${d.value}${d.critical ? '(C)' : ''}`).join(', ') || '-';

                    // Build posts/layout string
                    const layout = (r.posts || []).map(p => p.label).join('-') || '-';

                    return `<tr>
                        <td style="position: sticky; left: 0; background: white; z-index: 1; font-weight: 600;">${r.name || 'Room ' + (i + 1)}</td>
                        <td>${product}</td>
                        <td>${method}</td>
                        <td>${colour}</td>
                        <td>${hinge}</td>
                        <td>${louvre}</td>
                        <td>${tilt}</td>
                        <td>${layout}</td>
                        <td>${r.panelQty || '-'}</td>
                        <td>${stile}</td>
                        <td>${frame}</td>
                        <td>${r.frame?.left || '-'}</td>
                        <td>${r.frame?.top || '-'}</td>
                        <td>${r.frame?.right || '-'}</td>
                        <td>${r.frame?.bottom || '-'}</td>
                        <td>${mount}</td>
                        <td>${r.lightBlock || '-'}</td>
                        <td>${r.horizontal || '-'}</td>
                        <td>${r.width || '-'}</td>
                        <td>${r.height || '-'}</td>
                        <td>${midrails}</td>
                        <td>${r.split || '-'}</td>
                        <td>${r.blockOut || r.splitBlockOut || '-'}</td>
                        <td>${r.ringPull || '-'}</td>
                        <td>${r.handle || '-'}</td>
                        <td>${r.picture ? '✓' : '-'}</td>
                        <td>${r.flyscreenBeading || '-'}</td>
                        <td style="max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${r.comments || '-'}</td>
                    </tr>`;
                }).join('');
                document.getElementById('ssMainRows').innerHTML = rows;

                // Build Additional Items summary
                if (coverStripHeights.length > 0) {
                    const stripItems = coverStripHeights.map(h => `2× Cover Strips @ ${h}mm`);
                    additionalItems.push(stripItems.join(', '));
                }
                if (allPackers.length > 0) {
                    const packerText = allPackers.map(p => `${p.qty}× ${p.w}×${p.h}×${p.d}`).join(', ');
                    additionalItems.push(`Packers: ${packerText}`);
                }
            }

            // Populate Comments
            document.getElementById('ssComments').textContent = document.getElementById('jobComments').value || '-';

            // Populate Additional Items
            document.getElementById('ssAdditionalItems').innerHTML = additionalItems.length > 0
                ? additionalItems.map(item => `<div>${item}</div>`).join('')
                : '-';

            // Check customer signature
            const custSigBox = document.getElementById('sigBox');
            if (custSigBox && custSigBox.classList.contains('has-sig')) {
                document.getElementById('reviewCustSig').innerHTML = '<span style="color: var(--success);">✓ Signature Captured</span>';
                document.getElementById('reviewCustSig').style.color = 'var(--success)';
                document.getElementById('reviewCustSig').style.borderColor = 'var(--success)';
            }
        }


        function submitOrder() {
            generateReview();

            // Archive the job with FULL data for spreadsheet display
            const job = {
                id: Date.now(),
                ref: document.getElementById('jobRef').value,
                client: document.getElementById('clientName').value,
                address: document.getElementById('clientAddr').value,
                email: document.getElementById('clientEmail')?.value || '',
                phone: document.getElementById('clientPhone')?.value || '',
                consultant: document.getElementById('consultantEmail')?.value || '',
                surveyor: document.getElementById('surveyor')?.value || '',
                date: document.getElementById('jobDate').value,
                // Product specs
                product: document.getElementById('specProduct').value,
                method: document.getElementById('specMountMethod')?.value || '',
                colour: document.getElementById('specColor').value,
                hinge: document.getElementById('specHinge')?.value || '',
                louvreSize: document.getElementById('specBlade').value,
                stile: document.getElementById('specStile')?.value || '',
                frame: document.getElementById('specFrame').value,
                tilt: document.getElementById('specTilt').value,
                mount: document.getElementById('specMount').value,
                // Rooms data
                roomsData: JSON.parse(JSON.stringify(state.rooms)), // Deep copy
                roomCount: state.rooms.length,
                // Comments
                comments: document.getElementById('jobComments').value,
                // Status
                status: 'ordered',
                color: '#ffc107' // Orange for "On its way"
            };
            state.archive.push(job);
            localStorage.setItem('westralArchive', JSON.stringify(state.archive));
            renderArchive();

            // ---- Generate CSV file for download ----
            downloadOrderCSV(job);

            // ---- Build clean, readable email body ----
            const roomSummary = buildRoomSummary(job);
            const extras = buildExtras(job);

            const officeSubject = encodeURIComponent(`C/M ${job.ref || ''} ${job.client || ''}`);
            const officeBody = encodeURIComponent(
                `SHUTTER ORDER\n` +
                `Ref: ${job.ref}  |  Date: ${job.date}\n` +
                `\n` +
                `CLIENT\n` +
                `  Name:      ${job.client}\n` +
                `  Address:   ${job.address}\n` +
                `  Phone:     ${job.phone}\n` +
                `  Email:     ${job.email}\n` +
                `  Surveyor:  ${job.surveyor}\n` +
                `\n` +
                `DEFAULT SPECS\n` +
                `  Product:   ${job.product}\n` +
                `  Colour:    ${job.colour}\n` +
                `  Louvre:    ${job.louvreSize}\n` +
                `  Tilt:      ${job.tilt}\n` +
                `  Hinge:     ${job.hinge}\n` +
                `  Stile:     ${job.stile}\n` +
                `  Frame:     ${job.frame}\n` +
                `  Mount:     ${job.mount} (${job.method})\n` +
                `\n` +
                `ROOMS (${job.roomCount})\n` +
                roomSummary +
                `\n` +
                (extras ? `EXTRAS\n${extras}\n\n` : '') +
                `COMMENTS\n` +
                `  ${job.comments || 'None'}\n` +
                `\n` +
                `---\n` +
                `CSV spreadsheet auto-downloaded.\n` +
                `Please attach the CSV file to this email.\n`
            );
            window.open(`mailto:Angus@gasignite.com?subject=${officeSubject}&body=${officeBody}`, '_blank'); // Production: edmund.robless@westral.com.au

            // Email 2: To client (blank body, just address)
            const clientEmail = job.email;
            if (clientEmail) {
                const clientSubject = encodeURIComponent(`Shutter Order Confirmation - ${job.ref || ''}`);
                setTimeout(() => {
                    window.location.href = `mailto:${clientEmail}?subject=${clientSubject}`;
                }, 1500);
            }

            alert('Order Submitted!\n\n✓ Order placed in archive\n✓ CSV spreadsheet downloaded\n✓ Email to office opening...\n' + (clientEmail ? '✓ Client email will open next' : '⚠ No client email set') + '\n\n⚠ Remember to ATTACH the CSV file to the email!');

            // Clear active session after successful submission
            localStorage.removeItem('westralActiveSession');
        }

        // ============ PLEASE QUOTE - Clear survey tabs, keep client & product data ============
        function pleaseQuote() {
            if (!confirm('Clear all survey room tabs?\nClient details & product choices will be kept.')) return;

            state.rooms = [];
            state.currentRoom = 0;
            renderRoomTabs();

            // Clear signatures
            clearProjectSig();
            clearSurveyorSig();

            alert('Survey tabs cleared.\nClient details & product choices retained.\n\nReady for a fresh quote.');
        }

        // ============ SEND QUOTE - Email consultant with 'Please Quote [customer name]' ============
        function sendQuote() {
            const consultant = document.getElementById('consultantEmail')?.value;
            const clientName = document.getElementById('clientName')?.value || 'Customer';
            const jobRef = document.getElementById('jobRef')?.value || '';

            if (!consultant) {
                alert('No consultant email set.\nPlease enter a consultant email on the Project page first.');
                return;
            }

            const subject = encodeURIComponent('Please Quote ' + clientName + (jobRef ? ' - Ref: ' + jobRef : ''));
            const body = encodeURIComponent(
                'Hi,\n\n' +
                'Please quote for the following customer:\n\n' +
                'Name: ' + clientName + '\n' +
                'Address: ' + (document.getElementById('clientAddr')?.value || '-') + '\n' +
                'Phone: ' + (document.getElementById('clientPhone')?.value || '-') + '\n' +
                'Ref: ' + jobRef + '\n\n' +
                'Thanks'
            );

            window.open('mailto:' + consultant + '?subject=' + subject + '&body=' + body, '_blank');
        }

        // Build a concise numbered room list for email
        function buildRoomSummary(job) {
            if (!job.roomsData || job.roomsData.length === 0) return '  No rooms\n';
            let lines = [];
            job.roomsData.forEach((r, i) => {
                const roomProduct = r.specs?.product || job.product || '-';
                const w = r.width || '?';
                const h = r.height || '?';
                const panels = r.panelQty || '?';
                const midrails = (r.dividers || []).length;
                let line = `  ${i + 1}. ${r.name || 'Room ' + (i + 1)} — ${w}×${h}mm, ${panels} panel${panels != 1 ? 's' : ''}`;
                if (roomProduct !== job.product) line += ` [${roomProduct}]`;
                if (midrails > 0) line += ` +midrail`;
                if (r.notes) line += ` (${r.notes.substring(0, 40)}${r.notes.length > 40 ? '...' : ''})`;
                lines.push(line);
            });
            return lines.join('\n') + '\n';
        }

        // Build extras summary
        function buildExtras(job) {
            let extras = [];
            let allPackers = [];
            let coverStrips = [];
            (job.roomsData || []).forEach(r => {
                if (r.packers) allPackers = allPackers.concat(r.packers);
                if ((r.coverStrip === true || r.coverStrip === 'Yes') && r.height) {
                    coverStrips.push(`  Cover Strip @ ${r.height}mm`);
                }
            });
            if (allPackers.length > 0) extras.push('  Packers: ' + allPackers.map(p => `${p.qty}x ${p.w}×${p.h}×${p.d}`).join(', '));
            if (coverStrips.length > 0) extras = extras.concat(coverStrips);
            return extras.length > 0 ? extras.join('\n') + '\n' : '';
        }

        // Generate and download a CSV file with full room data
        function downloadOrderCSV(job) {
            const headers = [
                'Room', 'Product', 'Width (mm)', 'Height (mm)', 'Panels',
                'Method', 'Mount', 'Frame', 'Colour', 'Hinge', 'Louvre',
                'Tilt', 'Stile', 'Layout', 'Frame L', 'Frame T', 'Frame R', 'Frame B',
                'Midrail', 'Split', 'Notes'
            ];

            let rows = [headers.join(',')];

            if (job.roomsData && job.roomsData.length > 0) {
                job.roomsData.forEach((r, i) => {
                    const midrails = (r.dividers || []).map(d => `${d.value}${d.critical ? '(C)' : ''}`).join('; ') || '';
                    const layout = (r.posts || []).map(p => p.label).join('-') || '';
                    const roomProduct = r.specs?.product || job.product || '';
                    const csvEscape = (val) => {
                        val = String(val || '');
                        if (val.includes(',') || val.includes('"') || val.includes('\n')) {
                            return '"' + val.replace(/"/g, '""') + '"';
                        }
                        return val;
                    };
                    rows.push([
                        csvEscape(r.name || 'Room ' + (i + 1)),
                        csvEscape(roomProduct),
                        r.width || '',
                        r.height || '',
                        r.panelQty || '',
                        csvEscape(job.method),
                        csvEscape(job.mount),
                        csvEscape(job.frame),
                        csvEscape(job.colour),
                        csvEscape(job.hinge),
                        csvEscape(job.louvreSize),
                        csvEscape(job.tilt),
                        csvEscape(job.stile),
                        csvEscape(layout),
                        r.frame?.left || '',
                        r.frame?.top || '',
                        r.frame?.right || '',
                        r.frame?.bottom || '',
                        csvEscape(midrails),
                        csvEscape(r.split || ''),
                        csvEscape(r.comments || '')
                    ].join(','));
                });
            }

            // Add extras rows
            let allPackers = [];
            let coverStrips = [];
            (job.roomsData || []).forEach(r => {
                if (r.packers) allPackers = allPackers.concat(r.packers);
                if ((r.coverStrip === true || r.coverStrip === 'Yes') && r.height) {
                    coverStrips.push(`Cover Strip @ ${r.height}mm`);
                }
            });
            if (allPackers.length > 0 || coverStrips.length > 0) {
                rows.push(''); // blank row
                rows.push('EXTRAS');
                if (allPackers.length > 0) rows.push('Packers:,' + allPackers.map(p => `${p.qty}x ${p.w}x${p.h}x${p.d}`).join(', '));
                if (coverStrips.length > 0) rows.push('Cover Strips:,' + coverStrips.join(', '));
            }

            // Add job header info
            const headerRows = [
                `Client:,${job.client}`,
                `Address:,${job.address}`,
                `Phone:,${job.phone}`,
                `Ref:,${job.ref}`,
                `Date:,${job.date}`,
                `Surveyor:,${job.surveyor}`,
                `Product:,${job.product}`,
                `Colour:,${job.colour}`,
                ''  // blank row before data
            ];

            const csvContent = headerRows.join('\n') + '\n' + rows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const filename = `Order_${(job.ref || 'NoRef').replace(/[^a-zA-Z0-9-]/g, '_')}_${job.client.replace(/[^a-zA-Z0-9]/g, '_')}.csv`;
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ============ INSTALL TAB FUNCTIONS ============
        function clearInstallerSig() {
            const canvas = document.getElementById('installerSigCanvas');
            const box = document.getElementById('installerSigBox');
            const ctx = canvas.getContext('2d');
            if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
            box.classList.remove('has-sig');
            document.getElementById('installerSigPlaceholder').classList.remove('hidden');
        }

        function populateInstallJobSelector() {
            const select = document.getElementById('installJobSelector');
            if (!select) return;
            const orderedJobs = state.archive.filter(j => j.status === 'ordered');
            select.innerHTML = '<option value="">— Select an ordered job —</option>' +
                orderedJobs.map(j =>
                    `<option value="${j.id}">${j.client || 'Unknown'} — ${j.ref || 'No Ref'} (${j.date || ''})</option>`
                ).join('');
        }

        function loadArchivedJob(jobId) {
            if (!jobId) return;
            const job = state.archive.find(j => j.id === Number(jobId));
            if (!job) { alert('Job not found in archive.'); return; }

            // Repopulate client info
            document.getElementById('clientName').value = job.client || '';
            document.getElementById('clientAddr').value = job.address || '';
            if (document.getElementById('clientEmail')) document.getElementById('clientEmail').value = job.email || '';
            if (document.getElementById('clientPhone')) document.getElementById('clientPhone').value = job.phone || '';
            document.getElementById('jobRef').value = job.ref || '';
            if (document.getElementById('surveyor')) document.getElementById('surveyor').value = job.surveyor || '';
            document.getElementById('jobDate').value = job.date || '';
            document.getElementById('jobComments').value = job.comments || '';
            if (document.getElementById('consultantEmail')) document.getElementById('consultantEmail').value = job.consultant || '';

            // Repopulate product specs
            document.getElementById('specProduct').value = job.product || 'Woodlore';
            if (document.getElementById('specMountMethod')) document.getElementById('specMountMethod').value = job.method || 'Hinged';
            document.getElementById('specMount').value = job.mount || 'Recess';
            document.getElementById('specFrame').value = job.frame || 'Bullnose Z 38mm';
            if (document.getElementById('specStile')) document.getElementById('specStile').value = job.stile || 'Beaded Butt';
            document.getElementById('specColor').value = job.colour || '001 Pure White';
            if (document.getElementById('specHinge')) document.getElementById('specHinge').value = job.hinge || 'Pure White';
            document.getElementById('specTilt').value = job.tilt || 'EasyTilt';
            document.getElementById('specBlade').value = job.louvreSize || '89mm';

            // Repopulate rooms
            if (job.roomsData && job.roomsData.length > 0) {
                state.rooms = JSON.parse(JSON.stringify(job.roomsData)); // Deep copy
                state.currentRoom = 0;
                loadRoomData(0);
                renderRoomTabs();
            }

            // Also pre-fill install report fields
            if (document.getElementById('irCustomerName')) document.getElementById('irCustomerName').value = job.client || '';
            if (document.getElementById('irAddress')) document.getElementById('irAddress').value = job.address || '';

            alert(`Job loaded: ${job.client}\n\n✓ Client info restored\n✓ Product specs restored\n✓ ${state.rooms.length} room(s) restored\n\nReady for installation sign-off.`);
        }

        function completeInstallation() {
            // Validate checkboxes
            const checks = [1, 2, 3, 4, 5].map(i => document.getElementById('installCheck' + i).checked);
            const checkLabels = [
                'All products installed',
                'Operation, care & maintenance discussed',
                'Warranty information provided',
                'Site clean and well presented',
                'Invoice received'
            ];
            const allChecked = checks.every(c => c);
            if (!allChecked) {
                if (!confirm('Not all items are checked. Mark complete anyway?')) return;
            }
            if (!document.getElementById('installerSigBox').classList.contains('has-sig')) {
                alert('Please capture the client signature before completing.');
                return;
            }

            // Update archive status
            const ref = document.getElementById('jobRef').value;
            const clientName = document.getElementById('clientName').value;
            const job = state.archive.find(j => j.ref === ref);
            if (job) {
                job.status = 'complete';
                job.color = '#28a745';
                localStorage.setItem('westralArchive', JSON.stringify(state.archive));
            }

            // Build checklist text
            const checklistText = checks.map((c, i) => `${c ? '✓' : '✗'} ${checkLabels[i]}`).join('\n');
            const installComments = document.getElementById('installCompleteComments')?.value || 'None';
            const hasSig = document.getElementById('installerSigBox').classList.contains('has-sig');

            // Email to accounts@westral.com.au
            const subject = encodeURIComponent(`Complete ${ref || ''} ${clientName || ''}`);
            const body = encodeURIComponent(
                `INSTALLATION COMPLETE\n` +
                `${'='.repeat(40)}\n` +
                `Reference: ${ref}\n` +
                `Client: ${clientName}\n` +
                `Address: ${document.getElementById('clientAddr').value || '-'}\n\n` +
                `CHECKLIST\n` +
                `${'='.repeat(40)}\n` +
                `${checklistText}\n\n` +
                `COMMENTS\n` +
                `${'='.repeat(40)}\n` +
                `${installComments}\n\n` +
                `CLIENT SIGNATURE: ${hasSig ? '✓ Captured in app' : '✗ Not captured'}\n`
            );
            window.location.href = `mailto:Angus@gasignite.com?subject=${subject}&body=${body}`; // Production: accounts@westral.com.au

            alert('Installation Complete!\n\n✓ Job marked as finished\n✓ Archive updated\n✓ Email to accounts opening...');
            renderArchive();
        }

        // ========== GREEN REPORT FUNCTIONS ==========
        let irRowCount = 0;
        function addIRRow() {
            irRowCount++;
            const tbody = document.getElementById('irTableBody');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding: 4px; border: 1px solid #81c784; text-align: center;">${irRowCount}</td>
                <td style="padding: 2px; border: 1px solid #81c784;"><input type="text" style="width: 100%; border: none; padding: 4px; font-size: 11px;"></td>
                <td style="padding: 2px; border: 1px solid #81c784;"><input type="text" style="width: 100%; border: none; padding: 4px; font-size: 11px;"></td>
                <td style="padding: 2px; border: 1px solid #81c784;"><input type="text" style="width: 100%; border: none; padding: 4px; font-size: 11px;"></td>
            `;
            tbody.appendChild(tr);
        }

        // Report Photos
        let reportPhotos = [];
        function captureReportPhoto() {
            document.getElementById('reportPhotoCapture').click();
        }
        function browseReportPhoto() {
            document.getElementById('reportPhotoBrowse').click();
        }
        function handleReportPhoto(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                reportPhotos.push(e.target.result);
                renderReportPhotoThumbs();
            };
            reader.readAsDataURL(file);
            input.value = '';
        }
        function removeReportPhoto(idx) {
            reportPhotos.splice(idx, 1);
            renderReportPhotoThumbs();
        }
        function renderReportPhotoThumbs() {
            const container = document.getElementById('reportPhotoThumbs');
            const emptyMsg = document.getElementById('reportPhotosEmpty');
            if (reportPhotos.length === 0) {
                container.innerHTML = '';
                emptyMsg.style.display = 'block';
                return;
            }
            emptyMsg.style.display = 'none';
            container.innerHTML = reportPhotos.map((src, i) => `
                <div style="position: relative; width: 80px; height: 80px; border-radius: 6px; overflow: hidden; border: 1px solid var(--border);">
                    <img src="${src}" style="width: 100%; height: 100%; object-fit: cover;">
                    <div onclick="removeReportPhoto(${i})" style="position: absolute; top: 2px; right: 2px; width: 22px; height: 22px; background: rgba(200,30,30,0.85); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; cursor: pointer; line-height: 1;">×</div>
                </div>
            `).join('');
        }

        function submitInstallReport() {
            const reportNo = document.getElementById('irReportNo').value;
            const customer = document.getElementById('irCustomerName').value;
            const address = document.getElementById('irAddress').value;
            const problem = document.getElementById('irProblem').value;

            if (!problem) {
                alert('Please describe the nature of the problem before submitting.');
                return;
            }

            // Collect fault checkboxes
            const faults = [];
            if (document.getElementById('irFaultFactory').checked) faults.push('Factory');
            if (document.getElementById('irFaultInstaller').checked) faults.push('Installer');
            if (document.getElementById('irFaultDespatch').checked) faults.push('Despatch');
            if (document.getElementById('irFaultConsultant').checked) faults.push('Consultant');
            if (document.getElementById('irFaultBackCharge').checked) faults.push('Back Charge');

            // Build email body
            const jobRef = document.getElementById('jobRef').value;
            const subject = encodeURIComponent(`Incomplete ${jobRef || reportNo || ''} ${customer || 'Unknown'}`);
            const body = encodeURIComponent(
                `INSTALLATION REPORT (INCOMPLETE)\n` +
                `${'='.repeat(40)}\n` +
                `Report No: ${reportNo}\n` +
                `Customer: ${customer}\n` +
                `Address: ${address}\n` +
                `Installed Date: ${document.getElementById('irInstalledDate').value}\n` +
                `Measured by: ${document.getElementById('irMeasuredBy').value}\n` +
                `Fitted by: ${document.getElementById('irFittedBy').value}\n` +
                `Invoice No: ${document.getElementById('irInvoiceNo').value}\n` +
                `Written by: ${document.getElementById('irWrittenBy').value}\n\n` +
                `At Fault: ${faults.join(', ') || 'Not specified'}\n` +
                `Product: ${document.getElementById('irProduct').value}\n` +
                `Returned to Factory: ${document.getElementById('irReturnedToFactory').value}\n` +
                `C.O.D. Outstanding: ${document.getElementById('irCOD').value}\n` +
                `Date to be refitted: ${document.getElementById('irRefitDate').value}\n\n` +
                `NATURE OF PROBLEM\n` +
                `${'='.repeat(40)}\n` +
                `${problem}\n\n` +
                `Photos: ${reportPhotos.length} taken (please attach from camera roll)\n` +
                `Consultant advised: ${document.getElementById('irConsultantAdvised').value}`
            );

            window.location.href = `mailto:Angus@gasignite.com?subject=${subject}&body=${body}`; // Production: edmund.robless@westral.com.au

            // Update archive status to 'incomplete'
            const ref = document.getElementById('jobRef').value;
            const job = state.archive.find(j => j.ref === ref);
            if (job) {
                job.status = 'incomplete';
                job.color = '#dc3545';
                localStorage.setItem('westralArchive', JSON.stringify(state.archive));
                renderArchive();
            }

            alert('Email to office opening...\n\nPlease attach photos from your camera roll.\n\n✓ Job marked as incomplete in archive');
        }

        // ============ ARCHIVE TAB FUNCTIONS ============
        function renderArchive() {
            // Auto-delete jobs older than 6 months (180 days)
            const sixMonthsAgo = Date.now() - (180 * 24 * 60 * 60 * 1000);
            const before = state.archive.length;
            state.archive = state.archive.filter(j => j.id > sixMonthsAgo);
            if (state.archive.length < before) {
                localStorage.setItem('westralArchive', JSON.stringify(state.archive));
            }

            // Also update install job selector
            populateInstallJobSelector();

            const container = document.getElementById('archiveList');
            if (!state.archive.length) {
                container.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 12px; opacity: 0.5;"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
                    <p>No Archived Jobs</p>
                    <p style="font-size: 12px;">Completed jobs will appear here</p>
                </div>`;
                return;
            }

            container.innerHTML = state.archive.map(j => `
                <div class="card" style="border-left: 4px solid ${j.color}; cursor: pointer;" onclick="viewArchivedJob(${j.id})">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--norman-blue);">${j.client || 'Unknown Client'}</strong>
                            <p style="font-size: 12px; color: var(--text-muted);">Ref: ${j.ref || '-'} | ${j.date}</p>
                            <p style="font-size: 11px; color: var(--text-muted);">${j.roomCount || j.rooms || 0} room(s)</p>
                        </div>
                        <span style="background: ${j.color}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase;">${j.status}</span>
                    </div>
                </div>
            `).join('');
        }

        // View archived job in spreadsheet format
        function viewArchivedJob(jobId) {
            const job = state.archive.find(j => j.id === jobId);
            if (!job) return;

            // Build room rows
            let roomRows = '<tr><td colspan="20" style="text-align: center; color: var(--text-muted);">No room data available</td></tr>';
            if (job.roomsData && job.roomsData.length > 0) {
                roomRows = job.roomsData.map((r, i) => {
                    const midrails = (r.dividers || []).map(d => `${d.value}${d.critical ? '(C)' : ''}`).join(', ') || '-';
                    const layout = (r.posts || []).map(p => p.label).join('-') || '-';
                    return `<tr>
                        <td>${i + 1}</td>
                        <td>${r.name || 'Room ' + (i + 1)}</td>
                        <td>${layout}</td>
                        <td>${r.panelQty || '-'}</td>
                        <td>${r.frame?.left || '-'}</td>
                        <td>${r.frame?.top || '-'}</td>
                        <td>${r.frame?.right || '-'}</td>
                        <td>${r.frame?.bottom || '-'}</td>
                        <td>${r.mountType || '-'}</td>
                        <td>${r.lightBlock || '-'}</td>
                        <td>${r.horizontal || '-'}</td>
                        <td>${r.width || '-'}</td>
                        <td>${r.height || '-'}</td>
                        <td>${midrails}</td>
                        <td>${r.splitBlockOut || '-'}</td>
                        <td>${r.ringPull || '-'}</td>
                        <td>${r.handle || '-'}</td>
                        <td>${r.picture ? '✓' : '-'}</td>
                        <td>${r.flyscreenBeading || '-'}</td>
                        <td>${r.comments || '-'}</td>
                    </tr>`;
                }).join('');
            }

            // Create modal HTML
            const modalHTML = `
                <div id="archiveJobModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; overflow-y: auto; padding: 20px;">
                    <div style="max-width: 100%; background: white; border-radius: 12px; overflow: hidden;">
                        <!-- Header -->
                        <div style="background: var(--norman-blue); color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; font-size: 16px;">${job.client || 'Job Details'}</h3>
                                <p style="margin: 4px 0 0; font-size: 12px; opacity: 0.8;">Ref: ${job.ref || '-'} | ${job.date}</p>
                            </div>
                            <button onclick="closeArchiveModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; cursor: pointer;">✕</button>
                        </div>
                        
                        <!-- Client Row -->
                        <div style="overflow-x: auto; border-bottom: 2px solid var(--norman-blue);">
                            <table class="spec-table" style="font-size: 10px; margin: 0; min-width: 600px;">
                                <tr style="background: #e3f2fd;"><th>Name</th><th>Address</th><th>Email</th><th>Phone</th><th>Surveyor</th><th>Date</th></tr>
                                <tr><td>${job.client || '-'}</td><td>${job.address || '-'}</td><td>${job.email || '-'}</td><td>${job.phone || '-'}</td><td>${job.surveyor || '-'}</td><td>${job.date || '-'}</td></tr>
                            </table>
                        </div>
                        
                        <!-- Product Row -->
                        <div style="overflow-x: auto; border-bottom: 2px solid var(--norman-blue);">
                            <table class="spec-table" style="font-size: 10px; margin: 0; min-width: 600px;">
                                <tr style="background: #fff3e0;"><th>Product</th><th>Method</th><th>Colour</th><th>Hinge</th><th>Louvre</th><th>Stile</th><th>Frame</th><th>Tilt</th></tr>
                                <tr><td>${job.product || '-'}</td><td>${job.method || '-'}</td><td>${job.colour || '-'}</td><td>${job.hinge || '-'}</td><td>${job.louvreSize || '-'}</td><td>${job.stile || '-'}</td><td>${job.frame || '-'}</td><td>${job.tilt || '-'}</td></tr>
                            </table>
                        </div>
                        
                        <!-- Measurements -->
                        <div style="overflow-x: auto; max-height: 300px; overflow-y: auto;">
                            <table class="spec-table" style="font-size: 9px; margin: 0; min-width: 1600px;">
                                <thead style="position: sticky; top: 0;"><tr style="background: var(--norman-blue); color: white;">
                                    <th>#</th><th>Room</th><th>Layout</th><th>Panel</th><th>Left</th><th>Top</th><th>Right</th><th>Bottom</th><th>Mount</th><th>Light Block</th><th>Horiz</th><th>Width</th><th>Height</th><th>Midrail</th><th>Split</th><th>Ring Pull</th><th>Handle</th><th>Pic</th><th>Fly Bead</th><th>Notes</th>
                                </tr></thead>
                                <tbody>${roomRows}</tbody>
                            </table>
                        </div>
                        
                        <!-- Comments -->
                        <div style="padding: 12px; border-top: 2px solid var(--norman-blue); background: #f5f5f5;">
                            <label style="font-weight: 600; font-size: 11px; color: var(--norman-blue);">Comments:</label>
                            <div style="font-size: 12px; background: white; padding: 8px; border-radius: 4px; margin-top: 4px;">${job.comments || '-'}</div>
                        </div>
                        
                        <!-- Actions -->
                        <div style="padding: 12px; display: flex; gap: 8px;">
                            <button class="btn btn-outline" onclick="closeArchiveModal()" style="flex: 1;">Close</button>
                            <button class="btn btn-primary" onclick="emailArchivedJob(${job.id})" style="flex: 1;">Email to Office</button>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existing = document.getElementById('archiveJobModal');
            if (existing) existing.remove();

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeArchiveModal() {
            const modal = document.getElementById('archiveJobModal');
            if (modal) modal.remove();
        }

        function emailArchivedJob(jobId) {
            const job = state.archive.find(j => j.id === jobId);
            if (!job) return;

            // Create email body
            const subject = encodeURIComponent(`Shutter Order - ${job.ref || 'No Ref'} - ${job.client || 'Unknown'}`);
            let bodyText = `Job Reference: ${job.ref}\nClient: ${job.client}\nAddress: ${job.address}\nDate: ${job.date}\n\nProduct: ${job.product}\nColour: ${job.colour}\nFrame: ${job.frame}\nLouvre: ${job.louvreSize}\n\nRooms: ${job.roomCount || 0}\n\nComments: ${job.comments || 'None'}\n\nNOTE: A full CSV spreadsheet has been downloaded to your device. Please attach it to this email.`;
            const body = encodeURIComponent(bodyText);

            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        // ============ MOBILE OPTIMIZATION ============

        // Return key handling - blur input to dismiss keyboard and move to next field
        function setupReturnKeyHandling() {
            document.querySelectorAll('input[type="text"], input[type="number"], input[type="tel"], input[type="email"], textarea').forEach(input => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur();
                        // Find next focusable input if exists
                        const inputs = Array.from(document.querySelectorAll('input:not([type="hidden"]), select, textarea'));
                        const idx = inputs.indexOf(input);
                        if (idx > -1 && idx < inputs.length - 1) {
                            inputs[idx + 1].focus();
                        }
                    }
                });
            });
        }

        // Memory storage keys
        const MEMORY_KEYS = {
            layout: 'westral_layouts',
            posts: 'westral_posts',
            dividers: 'westral_dividers',
            split: 'westral_splits',
            packers: 'westral_packers'
        };

        // Add value to memory
        function addToMemory(key, value) {
            if (!value || !value.trim()) return;
            const storageKey = MEMORY_KEYS[key];
            if (!storageKey) return;

            let items = JSON.parse(localStorage.getItem(storageKey) || '[]');
            const trimmed = value.trim().toUpperCase();
            if (!items.includes(trimmed)) {
                items.unshift(trimmed); // Add to beginning
                items = items.slice(0, 20); // Keep last 20
                localStorage.setItem(storageKey, JSON.stringify(items));
            }
            updateDatalist(key);
        }

        // Get memory items
        function getMemory(key) {
            const storageKey = MEMORY_KEYS[key];
            if (!storageKey) return [];
            return JSON.parse(localStorage.getItem(storageKey) || '[]');
        }

        // Update datalist options
        function updateDatalist(key) {
            const datalist = document.getElementById(key + 'Memory');
            if (!datalist) return;
            const items = getMemory(key);
            datalist.innerHTML = items.map(v => `<option value="${v}">`).join('');
        }

        // Setup memory inputs with datalist
        function setupMemoryInputs() {
            const memoryFields = [
                { id: 'layout', key: 'layout' },
                { id: 'postPosition', key: 'posts' },
                { id: 'dividerValue', key: 'dividers' },
                { id: 'splitValue', key: 'split' },
                { id: 'packerValue', key: 'packers' }
            ];

            memoryFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (!input) return;

                // Add datalist for autocomplete
                const datalistId = field.key + 'Memory';
                if (!document.getElementById(datalistId)) {
                    const datalist = document.createElement('datalist');
                    datalist.id = datalistId;
                    document.body.appendChild(datalist);
                }
                input.setAttribute('list', datalistId);
                updateDatalist(field.key);

                // Save to memory on blur
                input.addEventListener('blur', () => {
                    addToMemory(field.key, input.value);
                });
            });
        }



        function downloadCSV() {
            // Save current room data first so state is up-to-date
            saveCurrentRoomData();

            // Build a job object from current form state
            const job = {
                ref: document.getElementById('jobRef').value,
                client: document.getElementById('clientName').value,
                address: document.getElementById('clientAddr').value,
                email: document.getElementById('clientEmail')?.value || '',
                phone: document.getElementById('clientPhone')?.value || '',
                surveyor: document.getElementById('surveyor')?.value || '',
                date: document.getElementById('jobDate').value,
                product: document.getElementById('specProduct').value,
                method: document.getElementById('specMountMethod')?.value || '',
                colour: document.getElementById('specColor').value,
                hinge: document.getElementById('specHinge')?.value || '',
                louvreSize: document.getElementById('specBlade').value,
                stile: document.getElementById('specStile')?.value || '',
                frame: document.getElementById('specFrame').value,
                tilt: document.getElementById('specTilt').value,
                mount: document.getElementById('specMount').value,
                roomsData: JSON.parse(JSON.stringify(state.rooms)),
                roomCount: state.rooms.length,
                comments: document.getElementById('jobComments').value
            };
            downloadOrderCSV(job);
        }





        // ============ START ============
        function init() {
            initApp(); // Date, surveyor name, defaults
            renderRoomTabs();
            setupReturnKeyHandling();
            setupMemoryInputs();
        }
        init();
    </script>
</body>

</html>